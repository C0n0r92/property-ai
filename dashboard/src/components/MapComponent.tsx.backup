'use client';

import { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import mapboxgl from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css';
import { formatFullPrice } from '@/lib/format';
import type { Property, Listing, RentalListing, RentalStats, Amenity, WalkabilityScore, RouteInfo, AmenitiesFilter } from '@/types/property';
import { SpiderfyManager, SpiderFeature } from '@/lib/spiderfy';
import { analytics } from '@/lib/analytics';
import { fetchAmenities, calculateWalkabilityScore, getCategoryIcon, formatCategory, getCategoryDisplayName, calculateDistance } from '@/lib/amenities';
import { PropertySnapshot } from '@/components/PropertySnapshot';
import { PlanningCard } from '@/components/PlanningCard';
import { PropertyReportButton } from '@/components/PropertyReportButton';
import { useSavedProperties } from '@/hooks/useSavedProperties';
import { useAuth } from '@/components/auth/AuthProvider';
import { usePropertyShare } from '@/hooks/usePropertyShare';
import { PropertyTypeFilter } from '@/components/filters/PropertyTypeFilter';
import { WalkabilityScore } from '@/components/walkability/WalkabilityScore';
import { WalkabilityBreakdown } from '@/components/walkability/WalkabilityBreakdown';
import { WalkabilityLegend } from '@/components/walkability/WalkabilityLegend';
import { DistanceDisplay } from '@/components/distance/DistanceDisplay';
import { DistanceFilter } from '@/components/filters/DistanceFilter';
import { getDistanceContext } from '@/lib/distance-calculator';

// Mapbox access token
const MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_TOKEN || '';
mapboxgl.accessToken = MAPBOX_TOKEN;

type DifferenceFilter = number | null;

// Data source selection - allows any combination
interface DataSourceSelection {
  sold: boolean;
  forSale: boolean;
  rentals: boolean;
  savedOnly: boolean;
}

// Month names for display
const MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
const QUARTER_MONTHS: Record<number, number[]> = {
  1: [0, 1, 2],   // Q1: Jan, Feb, Mar
  2: [3, 4, 5],   // Q2: Apr, May, Jun
  3: [6, 7, 8],   // Q3: Jul, Aug, Sep
  4: [9, 10, 11], // Q4: Oct, Nov, Dec
};

// Common Dublin areas for quick access
const DUBLIN_AREAS = [
  { name: 'Dublin City Centre', coords: [-6.2603, 53.3498], zoom: 14 },
  { name: 'Dublin 1', coords: [-6.2603, 53.3528], zoom: 14 },
  { name: 'Dublin 2', coords: [-6.2550, 53.3380], zoom: 14 },
  { name: 'Dublin 4', coords: [-6.2280, 53.3280], zoom: 14 },
  { name: 'Dublin 6', coords: [-6.2650, 53.3200], zoom: 14 },
  { name: 'Dublin 8', coords: [-6.2900, 53.3380], zoom: 14 },
  { name: 'Rathmines', coords: [-6.2650, 53.3220], zoom: 15 },
  { name: 'Ranelagh', coords: [-6.2580, 53.3260], zoom: 15 },
  { name: 'Drumcondra', coords: [-6.2550, 53.3700], zoom: 15 },
  { name: 'Sandymount', coords: [-6.2180, 53.3320], zoom: 15 },
  { name: 'Clontarf', coords: [-6.1900, 53.3650], zoom: 15 },
  { name: 'Howth', coords: [-6.0650, 53.3870], zoom: 14 },
  { name: 'Dun Laoghaire', coords: [-6.1350, 53.2940], zoom: 14 },
  { name: 'Blackrock', coords: [-6.1780, 53.3020], zoom: 15 },
  { name: 'Stillorgan', coords: [-6.2000, 53.2880], zoom: 15 },
  { name: 'Dundrum', coords: [-6.2450, 53.2920], zoom: 15 },
  { name: 'Tallaght', coords: [-6.3740, 53.2870], zoom: 14 },
  { name: 'Blanchardstown', coords: [-6.3880, 53.3930], zoom: 14 },
  { name: 'Swords', coords: [-6.2180, 53.4600], zoom: 14 },
];

// Mobile detection utility
const useIsMobile = () => {
  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    const checkIsMobile = () => {
      setIsMobile(window.innerWidth < 768); // md breakpoint
    };

    checkIsMobile();
    window.addEventListener('resize', checkIsMobile);
    return () => window.removeEventListener('resize', checkIsMobile);
  }, []);

  return isMobile;
};

// Skeleton loader component for planning applications
const PlanningSkeletonLoader = () => (
  <div className="space-y-3">
    {[1, 2, 3].map((i) => (
      <div key={i} className="bg-gray-800 rounded-lg p-3 border border-gray-700 animate-pulse">
        <div className="flex items-start justify-between mb-2">
          <div className="flex-1 min-w-0">
            <div className="h-4 bg-gray-600 rounded w-3/4 mb-1"></div>
            <div className="h-3 bg-gray-600 rounded w-1/2"></div>
          </div>
          <div className="h-3 bg-gray-600 rounded w-16"></div>
        </div>
        <div className="h-3 bg-gray-600 rounded w-full mb-1"></div>
        <div className="h-3 bg-gray-600 rounded w-2/3"></div>
      </div>
    ))}
  </div>
);

export default function MapComponent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { user } = useAuth();
  const { isSaved, saveProperty, unsaveProperty } = useSavedProperties();
  const isMobile = useIsMobile();
  const mapContainer = useRef<HTMLDivElement>(null);
  const map = useRef<mapboxgl.Map | null>(null);
  const spiderfyManager = useRef<SpiderfyManager | null>(null);
  const soldSnapshotRef = useRef<HTMLDivElement>(null);
  const listingSnapshotRef = useRef<HTMLDivElement>(null);
  const rentalSnapshotRef = useRef<HTMLDivElement>(null);
  const [properties, setProperties] = useState<Property[]>([]);
  const [listings, setListings] = useState<Listing[]>([]);
  const [rentals, setRentals] = useState<RentalListing[]>([]);

  const [loading, setLoading] = useState(false);
  const [loadingProgress, setLoadingProgress] = useState(0); // 0-100 percentage
  const [selectedProperty, setSelectedProperty] = useState<Property | null>(null);
  const [selectedListing, setSelectedListing] = useState<Listing | null>(null);
  const [selectedRental, setSelectedRental] = useState<RentalListing | null>(null);
  const isClosingRef = useRef(false);
  const isLoadingRef = useRef(false);


  const [mapReady, setMapReady] = useState(false);
  const [mapError, setMapError] = useState<string | null>(null);
  const [zoomLevel, setZoomLevel] = useState(11); // Track zoom for legend display
  const [viewMode, setViewMode] = useState<'clusters' | 'price' | 'difference'>('clusters');
  const [differenceFilter, setDifferenceFilter] = useState<DifferenceFilter>(null);
  
  // Data source toggle: allows any combination of sold, forSale, rentals
  const [dataSources, setDataSources] = useState<DataSourceSelection>({ sold: true, forSale: true, rentals: true, savedOnly: false });
  
  // Hierarchical time filter state (only for sold properties)
  const [selectedYear, setSelectedYear] = useState<number | null>(null);
  const [selectedQuarter, setSelectedQuarter] = useState<number | null>(null);
  const [selectedMonth, setSelectedMonth] = useState<number | null>(null);
  const [recentFilter, setRecentFilter] = useState<'6m' | '12m' | null>(null);
  const [timeFilter, setTimeFilter] = useState<'today' | 'thisWeek' | 'thisMonth' | 'lastWeek' | 'lastMonth' | null>(null);
  
  const [stats, setStats] = useState({ total: 0, avgPrice: 0, avgPricePerSqm: 0, overAsking: 0, underAsking: 0 });
  const [listingStats, setListingStats] = useState({ totalListings: 0, medianPrice: 0, avgPricePerSqm: 0 });
  const [rentalStats, setRentalStats] = useState<RentalStats>({ totalRentals: 0, medianRent: 0, avgRentPerSqm: 0, rentRange: { min: 0, max: 0 } });
  
  // Search state
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState<Array<{ place_name: string; center: [number, number] }>>([]);
  const [showSearchResults, setShowSearchResults] = useState(false);
  const [isSearching, setIsSearching] = useState(false);
  const [searchedLocation, setSearchedLocation] = useState<{ name: string; coords: [number, number] } | null>(null);
  const searchTimeout = useRef<NodeJS.Timeout | null>(null);

  // Collapsible filter panel state - hidden on mobile, open on desktop by default
  const [showFilters, setShowFilters] = useState(false);

  // Amenities layer state
  const [showAmenities, setShowAmenities] = useState(false);
  const [amenities, setAmenities] = useState<Amenity[]>([]);
  const [amenitiesCache, setAmenitiesCache] = useState<Map<string, Amenity[]>>(new Map());
  const [walkabilityScore, setWalkabilityScore] = useState<WalkabilityScore | null>(null);

  // Category filtering
  const [categoryFilters, setCategoryFilters] = useState<AmenitiesFilter>({
    public_transport: true,
    education: true,
    healthcare: true,
    shopping: true,
    leisure: true,
    services: true,
  });

  // Route visualization
  const [selectedAmenity, setSelectedAmenity] = useState<Amenity | null>(null);
  const [routeInfo, setRouteInfo] = useState<RouteInfo | null>(null);
  const [travelMode, setTravelMode] = useState<'walking' | 'cycling' | 'driving'>('walking');

  // Mobile-specific states
  const [activeTab, setActiveTab] = useState<'details' | 'planning'>('details');
  const [isMobileAmenitiesMode, setIsMobileAmenitiesMode] = useState(false);

  // Handle query parameters for focusing on specific properties and search
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const focusId = urlParams.get('focus');
    const focusType = urlParams.get('type');
    const searchQuery = urlParams.get('search');

    if (focusId && focusType && !loading) {
      // Wait a bit for data to load, then find and focus the property
      const timer = setTimeout(() => {
        if (focusType === 'listing') {
          // Check sold properties first (they use address as ID)
          const property = properties.find(p => p.address === focusId);
          if (property) {
            setSelectedProperty(property);
            setActiveTab('details'); // Reset to details tab when focusing property
            if (isMobile) setShowFilters(false); // Close filters on mobile when focusing property
            // Center map on the property
            if (map.current && property.latitude && property.longitude) {
              map.current.flyTo({
                center: [property.longitude, property.latitude],
                zoom: 16
              });
            }
            return;
          }

          // Check listings
          const listing = listings.find(l => l.address === focusId);
          if (listing) {
            setSelectedListing(listing);
            setActiveTab('details'); // Reset to details tab when focusing listing
            if (isMobile) setShowFilters(false); // Close filters on mobile when focusing listing
            // Center map on the listing
            if (map.current && listing.latitude && listing.longitude) {
              map.current.flyTo({
                center: [listing.longitude, listing.latitude],
                zoom: 16
              });
            }
            return;
          }
        } else if (focusType === 'rental') {
          // Check rentals
          const rental = rentals.find(r => r.address === focusId);
          if (rental) {
            setSelectedRental(rental);
            setActiveTab('details'); // Reset to details tab when focusing rental
            if (isMobile) setShowFilters(false); // Close filters on mobile when focusing rental
            // Center map on the rental
            if (map.current && rental.latitude && rental.longitude) {
              map.current.flyTo({
                center: [rental.longitude, rental.latitude],
                zoom: 16
              });
            }
            return;
          }
        }

        // Clean up URL parameters after processing
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.delete('focus');
        newUrl.searchParams.delete('type');
        window.history.replaceState({}, '', newUrl.toString());
      }, 2000); // Wait 2 seconds for data to load

      return () => clearTimeout(timer);
    }

    // Handle search query parameter - automatically search and focus
    if (searchQuery && searchQuery.trim() && !loading && mapReady) {
      // Wait a bit for map to be ready, then perform search and auto-focus
      const timer = setTimeout(async () => {
        try {
          const response = await fetch(
            `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(searchQuery)}.json?` +
            `access_token=${process.env.NEXT_PUBLIC_MAPBOX_TOKEN || ''}&` +
            `country=IE&` +
            `bbox=-6.6,53.1,-5.9,53.6&` +
            `limit=1` // Get just the best match
          );
          const data = await response.json();
          const features = data.features || [];

          if (features.length > 0) {
            const bestMatch = features[0];
            const coords: [number, number] = [bestMatch.center[0], bestMatch.center[1]];

            // Fly to the location
            flyToLocation(coords, 14);

            // Set search state for UI consistency
            setSearchQuery(bestMatch.place_name.split(',')[0]);
            setSearchedLocation({
              name: bestMatch.place_name,
              coords: coords
            });
            setSearchResults([]);
            setShowSearchResults(false);
          }
        } catch (error) {
          console.error('Auto-search error:', error);
        }
      }, 1500); // Slightly longer delay to ensure map is fully ready
      return () => clearTimeout(timer);
    }
  }, [loading, properties, listings, rentals, mapReady]);

  // Auto-close filters on mobile screens
  useEffect(() => {
    if (isMobile && showFilters) {
      setShowFilters(false);
    }
  }, [isMobile, showFilters]);

  // Remove planning radius function
  const removePlanningRadius = useCallback(() => {
    if (!map.current) return;

    try {
      // Remove planning-radius layers and source
      if (map.current.getLayer('planning-radius-outline')) {
        map.current.removeLayer('planning-radius-outline');
      }
      if (map.current.getLayer('planning-radius-fill')) {
        map.current.removeLayer('planning-radius-fill');
      }
      if (map.current.getLayer('planning-radius-center')) {
        map.current.removeLayer('planning-radius-center');
      }
      if (map.current.getSource('planning-radius')) {
        map.current.removeSource('planning-radius');
      }

      // Remove planning-center layers and source
      if (map.current.getLayer('planning-center-marker')) {
        map.current.removeLayer('planning-center-marker');
      }
      if (map.current.getSource('planning-center')) {
        map.current.removeSource('planning-center');
      }
    } catch (error) {
      // Source/layers might not exist, ignore
    }
  }, []);

  // Planning radius visualization function
  const addPlanningRadius = useCallback(() => {
    if (!map.current || !mapReady) {
      return;
    }

    const currentProperty = selectedProperty || selectedListing || selectedRental;
    if (!currentProperty?.latitude || !currentProperty?.longitude) return;

    // Only show radius at reasonable zoom levels (zoomed in enough to see 150m)
    const currentZoom = map.current.getZoom();
    if (currentZoom < 12) {
      return;
    }


    // Create a circle with 150m radius (our max search radius, made larger for visibility)
    const center = [currentProperty.longitude, currentProperty.latitude];
    const radiusKm = 0.15; // 150 meters in kilometers

    // Create circle coordinates (approximate)
    const points = 64;
    const coords = [];
    for (let i = 0; i <= points; i++) {
      const angle = (i * 360) / points;
      const radian = (angle * Math.PI) / 180;
      const lat = currentProperty.latitude + (radiusKm / 111.32) * Math.cos(radian);
      const lng = currentProperty.longitude + (radiusKm / (111.32 * Math.cos(currentProperty.latitude * Math.PI / 180))) * Math.sin(radian);
      coords.push([lng, lat]);
    }

    const circleGeoJson = {
      type: 'Feature' as const,
      geometry: {
        type: 'Polygon' as const,
        coordinates: [coords]
      },
      properties: {}
    };


    try {
      // Remove existing sources and layers if they exist
      if (map.current?.getSource('planning-radius')) {
        // Remove layers first
        if (map.current?.getLayer('planning-radius-outline')) {
          map.current?.removeLayer('planning-radius-outline');
        }
        if (map.current?.getLayer('planning-radius-fill')) {
          map.current?.removeLayer('planning-radius-fill');
        }
        if (map.current?.getLayer('planning-radius-center')) {
          map.current?.removeLayer('planning-radius-center');
        }
        // Then remove the source
        map.current?.removeSource('planning-radius');
      }

      if (map.current?.getSource('planning-center')) {
        // Remove center marker layer first
        if (map.current?.getLayer('planning-center-marker')) {
          map.current?.removeLayer('planning-center-marker');
        }
        // Then remove the source
        map.current?.removeSource('planning-center');
      }

      // Add source and layers
      map.current?.addSource('planning-radius', {
        type: 'geojson',
        data: circleGeoJson
      });

      // Fill layer - make it more visible
      map.current?.addLayer({
        id: 'planning-radius-fill',
        type: 'fill',
        source: 'planning-radius',
        paint: {
          'fill-color': '#3b82f6',
          'fill-opacity': 0.2  // Increased opacity
        }
      });

      // Outline layer - make it thicker
      map.current?.addLayer({
        id: 'planning-radius-outline',
        type: 'line',
        source: 'planning-radius',
        paint: {
          'line-color': '#3b82f6',
          'line-width': 3,  // Thicker line
          'line-dasharray': [5, 3]  // More visible dash pattern
        }
      });

      // Add a center marker for the property
      const centerGeoJson = {
        type: 'Feature' as const,
        geometry: {
          type: 'Point' as const,
          coordinates: center
        },
        properties: {}
      };

      map.current?.addSource('planning-center', {
        type: 'geojson',
        data: centerGeoJson
      });

      map.current?.addLayer({
        id: 'planning-center-marker',
        type: 'circle',
        source: 'planning-center',
        paint: {
          'circle-radius': 8,
          'circle-color': '#3b82f6',
          'circle-stroke-width': 2,
          'circle-stroke-color': '#ffffff'
        }
      });

      console.log('Planning radius and center marker added successfully');
    } catch (error) {
      console.error('Error adding planning radius layers:', error);
    }
  }, [selectedProperty, selectedListing, selectedRental]);

  // Loading and error states
  const [loadingAmenities, setLoadingAmenities] = useState(false);
  const [amenitiesError, setAmenitiesError] = useState<string | null>(null);
  
  // Open filters on desktop by default
  useEffect(() => {
    const isDesktop = window.innerWidth >= 768; // md breakpoint
    if (isDesktop) {
      setShowFilters(true);
    }
  }, []);
  
  // New filter states
  const [bedsFilter, setBedsFilter] = useState<number | null>(null);
  const [propertyTypeFilter, setPropertyTypeFilter] = useState<string | null>(null);
  const [selectedPropertyTypes, setSelectedPropertyTypes] = useState<string[]>([]);
  const [selectedDistanceBands, setSelectedDistanceBands] = useState<string[]>([]);
  const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);
  const [minPrice, setMinPrice] = useState<number | null>(null);
  const [maxPrice, setMaxPrice] = useState<number | null>(null);
  const [minArea, setMinArea] = useState<number | null>(null);
  const [maxArea, setMaxArea] = useState<number | null>(null);
  const [yieldFilter, setYieldFilter] = useState<number | null>(null);

  // Property sharing hooks
  const soldShare = usePropertyShare(soldSnapshotRef, selectedProperty, 'sold');
  const listingShare = usePropertyShare(listingSnapshotRef, selectedListing, 'forSale');
  const rentalShare = usePropertyShare(rentalSnapshotRef, selectedRental, 'rental');

  // Analytics-wrapped state setters
  const handleViewModeChange = (mode: 'clusters' | 'price' | 'difference') => {
    setViewMode(mode);
    analytics.mapViewModeChanged(mode);
  };

  const toggleDataSource = (source: keyof DataSourceSelection) => {
    setDataSources(prev => {
      const newSources = { ...prev, [source]: !prev[source] };
      // Ensure at least one source is selected
      if (!newSources.sold && !newSources.forSale && !newSources.rentals) {
        return prev; // Don't allow deselecting all
      }
      
      // Auto-select appropriate view mode based on data sources
      // Only sold selected -> difference (over asking)
      if (newSources.sold && !newSources.forSale && !newSources.rentals) {
        setViewMode('difference');
      }
      // Sold + for sale (no rentals) -> price
      else if (newSources.sold && newSources.forSale && !newSources.rentals) {
        setViewMode('price');
      }
      // All 3 selected -> clusters
      else if (newSources.sold && newSources.forSale && newSources.rentals) {
        setViewMode('clusters');
      }
      // If sold is being deselected and we're in difference view, switch to clusters
      else if (!newSources.sold && viewMode === 'difference') {
        setViewMode('clusters');
      }
      
      return newSources;
    });
    analytics.mapDataSourceChanged(source);
    setSelectedProperty(null);
    setSelectedListing(null);
    setSelectedRental(null);
  };
  
  // Helper to check if only one source type is active
  const isSingleSource = (source: keyof DataSourceSelection) => {
    return dataSources[source] && 
      Object.entries(dataSources).filter(([_, v]) => v).length === 1;
  };
  
  // Helper to check active source count
  const activeSourceCount = Object.values(dataSources).filter(Boolean).length;

  const handleFilterChange = (filterType: string, value: string) => {
    analytics.mapFilterApplied(filterType, value);
  };

  const handleClearFilters = () => {
    setSelectedYear(null);
    setSelectedQuarter(null);
    setSelectedMonth(null);
    setRecentFilter(null);
    setBedsFilter(null);
    setPropertyTypeFilter(null);
    setSelectedPropertyTypes([]);
    setSelectedDistanceBands([]);
    setMinPrice(null);
    setMaxPrice(null);
    setYieldFilter(null);
    setDifferenceFilter(null);
    analytics.filtersCleared();
  };

  // Search for location using Mapbox Geocoding API
  const searchLocation = async (query: string) => {
    if (!query.trim()) {
      setSearchResults([]);
      setSearchedLocation(null); // Clear previous search marker
      return;
    }

    setIsSearching(true);
    try {
      // Bias search towards Dublin
      const response = await fetch(
        `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
        `access_token=${process.env.NEXT_PUBLIC_MAPBOX_TOKEN || ''}&` +
        `country=IE&` +
        `bbox=-6.6,53.1,-5.9,53.6&` + // Dublin bounding box
        `limit=5`
      );
      const data = await response.json();
      setSearchResults(data.features || []);
      setShowSearchResults(true);
    } catch (error) {
      console.error('Search error:', error);
    }
    setIsSearching(false);
  };

  // Debounced search
  const handleSearchChange = (value: string) => {
    setSearchQuery(value);

    // Clear searched location if search is cleared
    if (!value.trim()) {
      setSearchedLocation(null);
    }

    if (searchTimeout.current) {
      clearTimeout(searchTimeout.current);
    }
    searchTimeout.current = setTimeout(() => {
      searchLocation(value);
    }, 300);
  };

  // Fly to location
  const flyToLocation = (coords: [number, number], zoom: number = 14) => {
    if (map.current) {
      map.current.flyTo({
        center: coords,
        zoom: zoom,
        duration: 1500,
      });
    }
    setShowSearchResults(false);
    setSearchQuery('');
  };

  // Handle spider feature click (when user clicks on a spiderfied marker)
  const handleSpiderFeatureClick = useCallback((spiderFeature: SpiderFeature) => {
    // Prevent reopening if we just closed a card
    if (isClosingRef.current) {
      console.log('Ignoring spider click - card is being closed');
      return;
    }
    
    const props = spiderFeature.properties;
    if (props?.isRental) {
      // Find the full rental object from the rentals array
      const fullRental = rentals.find(r => r.address === props?.address);
      if (fullRental) {
        setSelectedRental(fullRental);
        setActiveTab('details'); // Reset to details tab when selecting new rental
        if (isMobile) setShowFilters(false); // Close filters on mobile when selecting rental
        analytics.mapPropertyClicked('rental');
      }
      setSelectedProperty(null);
      setSelectedListing(null);
    } else if (props?.isListing) {
      // Find the full listing object from the listings array
      const fullListing = listings.find(l => l.address === props?.address);
      if (fullListing) {
        setSelectedListing(fullListing);
        setActiveTab('details'); // Reset to details tab when selecting new listing
        if (isMobile) setShowFilters(false); // Close filters on mobile when selecting listing
        analytics.mapPropertyClicked('forSale');
      }
      setSelectedProperty(null);
      setSelectedRental(null);
    } else {
      // Find the full property object from the properties array
      const fullProperty = properties.find(p => p.address === props?.address);
      if (fullProperty) {
        setSelectedProperty(fullProperty);
        setActiveTab('details'); // Reset to details tab when selecting new property
        analytics.mapPropertyClicked('sold');
      }
      setSelectedListing(null);
      setSelectedRental(null);
    }
  }, [rentals, listings, properties]);

  // Load data for current map viewport (progressive loading)
  const loadMapData = useCallback(async (bounds?: { north: number; south: number; east: number; west: number }, forceRefresh = false) => {
    // Prevent multiple simultaneous loads using ref
    if (isLoadingRef.current) return;

    // Only fetch data for selected sources
    const sources = [];
    if (dataSources.sold) sources.push('sold');
    if (dataSources.forSale) sources.push('forSale');
    if (dataSources.rentals) sources.push('rentals');

    if (sources.length === 0) return;

    isLoadingRef.current = true;
    setLoading(true);

    // Use provided bounds or get current map bounds
    let mapBounds: { north: number; south: number; east: number; west: number };
    if (bounds) {
      mapBounds = bounds;
    } else {
      // Fallback to Dublin bounds for initial load
      mapBounds = {
        north: 53.6,
        south: 53.2,
        east: -6.0,
        west: -6.5,
      };
    }

    // Build time filter parameter
    let timeFilterParam = '';
    if (timeFilter) {
      timeFilterParam = `&timeFilter=${timeFilter}`;
    } else if (recentFilter) {
      // Map existing filters to valid timeFilter values
      if (recentFilter === '6m') timeFilterParam = '&timeFilter=lastMonth'; // Use lastMonth as approximation
      if (recentFilter === '12m') timeFilterParam = '&timeFilter=lastMonth'; // Use lastMonth as approximation
    }

    console.log(`ðŸ“ Loading data from JSON file for sources:`, sources);

    try {
      // Load data directly from the consolidated JSON file
      const response = await fetch('/data.json');
      if (!response.ok) {
        throw new Error(`Failed to load data.json: ${response.status}`);
      }

      const data = await response.json();

      // Extract data based on selected sources
      let allProperties: Property[] = [];
      let allListings: Listing[] = [];
      let allRentals: RentalListing[] = [];

      if (sources.includes('sold') && data.properties) {
        allProperties = data.properties.filter((p: Property) => {
          // Apply basic filtering
          const year = parseInt(p.soldDate?.split('-')[0] || '0');
          return year >= 2015 && year <= 2025 && p.soldPrice >= 10000 && p.soldPrice <= 50000000;
        });
      }

      if (sources.includes('forSale') && data.listings) {
        allListings = data.listings.filter((l: Listing) => {
          // Apply basic filtering
          return l.askingPrice >= 10000 && l.askingPrice <= 100000000;
        });
      }

      if (sources.includes('rentals') && data.rentals) {
        allRentals = data.rentals.filter((r: RentalListing) => {
          // Apply basic filtering
          return r.monthlyRent >= 200 && r.monthlyRent <= 50000;
        });
      }

      // Apply time filtering if specified
      const now = new Date();
      if (timeFilter || recentFilter) {
        if (sources.includes('sold')) {
          allProperties = allProperties.filter(p => {
            const soldDate = new Date(p.soldDate);
            let matchesFilter = true;

            if (timeFilter) {
              switch (timeFilter) {
                case 'today':
                  matchesFilter = soldDate.toDateString() === now.toDateString();
                  break;
                case 'thisWeek': {
                  const startOfWeek = new Date(now);
                  startOfWeek.setDate(now.getDate() - now.getDay());
                  startOfWeek.setHours(0, 0, 0, 0);
                  matchesFilter = soldDate >= startOfWeek;
                  break;
                }
                case 'thisMonth': {
                  matchesFilter = soldDate.getMonth() === now.getMonth() && soldDate.getFullYear() === now.getFullYear();
                  break;
                }
                case 'lastWeek': {
                  const startOfLastWeek = new Date(now);
                  startOfLastWeek.setDate(now.getDate() - now.getDay() - 7);
                  startOfLastWeek.setHours(0, 0, 0, 0);
                  const endOfLastWeek = new Date(startOfLastWeek);
                  endOfLastWeek.setDate(startOfLastWeek.getDate() + 6);
                  endOfLastWeek.setHours(23, 59, 59, 999);
                  matchesFilter = soldDate >= startOfLastWeek && soldDate <= endOfLastWeek;
                  break;
                }
                case 'lastMonth': {
                  const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                  matchesFilter = soldDate.getMonth() === lastMonth.getMonth() && soldDate.getFullYear() === lastMonth.getFullYear();
                  break;
                }
                default:
                  matchesFilter = true;
              }
            } else if (recentFilter) {
              // Map existing filters to time ranges
              if (recentFilter === '6m') {
                const sixMonthsAgo = new Date(now);
                sixMonthsAgo.setMonth(now.getMonth() - 6);
                matchesFilter = soldDate >= sixMonthsAgo;
              } else if (recentFilter === '12m') {
                const twelveMonthsAgo = new Date(now);
                twelveMonthsAgo.setFullYear(now.getFullYear() - 1);
                matchesFilter = soldDate >= twelveMonthsAgo;
              }
            }

            return matchesFilter;
          });
        }

        if (sources.includes('forSale')) {
          allListings = allListings.filter(l => {
            const scrapedDate = new Date(l.scrapedAt);
            let matchesFilter = true;

            if (timeFilter) {
              switch (timeFilter) {
                case 'today':
                  matchesFilter = scrapedDate.toDateString() === now.toDateString();
                  break;
                case 'thisWeek': {
                  const startOfWeek = new Date(now);
                  startOfWeek.setDate(now.getDate() - now.getDay());
                  startOfWeek.setHours(0, 0, 0, 0);
                  matchesFilter = scrapedDate >= startOfWeek;
                  break;
                }
                case 'thisMonth': {
                  matchesFilter = scrapedDate.getMonth() === now.getMonth() && scrapedDate.getFullYear() === now.getFullYear();
                  break;
                }
                case 'lastWeek': {
                  const startOfLastWeek = new Date(now);
                  startOfLastWeek.setDate(now.getDate() - now.getDay() - 7);
                  startOfLastWeek.setHours(0, 0, 0, 0);
                  const endOfLastWeek = new Date(startOfLastWeek);
                  endOfLastWeek.setDate(startOfLastWeek.getDate() + 6);
                  endOfLastWeek.setHours(23, 59, 59, 999);
                  matchesFilter = scrapedDate >= startOfLastWeek && scrapedDate <= endOfLastWeek;
                  break;
                }
                case 'lastMonth': {
                  const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                  matchesFilter = scrapedDate.getMonth() === lastMonth.getMonth() && scrapedDate.getFullYear() === lastMonth.getFullYear();
                  break;
                }
                default:
                  matchesFilter = true;
              }
            } else if (recentFilter) {
              // Map existing filters to time ranges
              if (recentFilter === '6m') {
                const sixMonthsAgo = new Date(now);
                sixMonthsAgo.setMonth(now.getMonth() - 6);
                matchesFilter = scrapedDate >= sixMonthsAgo;
              } else if (recentFilter === '12m') {
                const twelveMonthsAgo = new Date(now);
                twelveMonthsAgo.setFullYear(now.getFullYear() - 1);
                matchesFilter = scrapedDate >= twelveMonthsAgo;
              }
            }

            return matchesFilter;
          });
        }

        if (sources.includes('rentals')) {
          allRentals = allRentals.filter(r => {
            const scrapedDate = new Date(r.scrapedAt);
            let matchesFilter = true;

            if (timeFilter) {
              switch (timeFilter) {
                case 'today':
                  matchesFilter = scrapedDate.toDateString() === now.toDateString();
                  break;
                case 'thisWeek': {
                  const startOfWeek = new Date(now);
                  startOfWeek.setDate(now.getDate() - now.getDay());
                  startOfWeek.setHours(0, 0, 0, 0);
                  matchesFilter = scrapedDate >= startOfWeek;
                  break;
                }
                case 'thisMonth': {
                  matchesFilter = scrapedDate.getMonth() === now.getMonth() && scrapedDate.getFullYear() === now.getFullYear();
                  break;
                }
                case 'lastWeek': {
                  const startOfLastWeek = new Date(now);
                  startOfLastWeek.setDate(now.getDate() - now.getDay() - 7);
                  startOfLastWeek.setHours(0, 0, 0, 0);
                  const endOfLastWeek = new Date(startOfLastWeek);
                  endOfLastWeek.setDate(startOfLastWeek.getDate() + 6);
                  endOfLastWeek.setHours(23, 59, 59, 999);
                  matchesFilter = scrapedDate >= startOfLastWeek && scrapedDate <= endOfLastWeek;
                  break;
                }
                case 'lastMonth': {
                  const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                  matchesFilter = scrapedDate.getMonth() === lastMonth.getMonth() && scrapedDate.getFullYear() === lastMonth.getFullYear();
                  break;
                }
                default:
                  matchesFilter = true;
              }
            } else if (recentFilter) {
              // Map existing filters to time ranges
              if (recentFilter === '6m') {
                const sixMonthsAgo = new Date(now);
                sixMonthsAgo.setMonth(now.getMonth() - 6);
                matchesFilter = scrapedDate >= sixMonthsAgo;
              } else if (recentFilter === '12m') {
                const twelveMonthsAgo = new Date(now);
                twelveMonthsAgo.setFullYear(now.getFullYear() - 1);
                matchesFilter = scrapedDate >= twelveMonthsAgo;
              }
            }

            return matchesFilter;
          });
        }
      }

      // Update state with loaded data
      setProperties([...allProperties]);
      setListings([...allListings]);
      setRentals([...allRentals]);

      // Calculate and update stats
      if (allProperties.length > 0) {
        const withAsking = allProperties.filter((p: Property) => p.askingPrice && p.askingPrice > 0);
        const overAsking = withAsking.filter((p: Property) => p.soldPrice > p.askingPrice!).length;
        const underAsking = withAsking.filter((p: Property) => p.soldPrice < p.askingPrice!).length;
        const avgPrice = allProperties.reduce((sum, p) => sum + p.soldPrice, 0) / allProperties.length;

        // Calculate average price per square meter
        const withSqm = allProperties.filter((p: Property) => p.pricePerSqm && p.pricePerSqm > 0);
        const avgPricePerSqm = withSqm.length > 0
          ? Math.round(withSqm.reduce((sum, p) => sum + (p.pricePerSqm || 0), 0) / withSqm.length)
          : 0;

        setStats({
          total: allProperties.length,
          avgPrice,
          avgPricePerSqm,
          overAsking,
          underAsking,
        });
      }

      console.log(`âœ… Loaded ${allProperties.length} properties, ${allListings.length} listings, ${allRentals.length} rentals from data.json`);
    } catch (error) {
      console.error('âŒ Error loading map data from JSON:', error);
      setMapError('Failed to load property data from data.json. Please try refreshing the page.');
    } finally {
      isLoadingRef.current = false;
      setLoading(false);
      setLoadingProgress(100);
    }
  }, [dataSources.sold, dataSources.forSale, dataSources.rentals, timeFilter, recentFilter, selectedYear]);

  // Note: We load all properties initially and don't reload on map move
  // The map uses clustering which efficiently handles large datasets
  // If you need progressive loading, uncomment this effect and modify loadMapData to use bounds
  /*
  useEffect(() => {
    if (!map.current) return;

    let moveTimeout: NodeJS.Timeout;

    const handleMapMove = () => {
      // Debounce map move events to avoid excessive API calls
      clearTimeout(moveTimeout);
      moveTimeout = setTimeout(() => {
        const bounds = map.current?.getBounds();
        if (bounds) {
          const boundsObj = {
            north: bounds.getNorth(),
            south: bounds.getSouth(),
            east: bounds.getEast(),
            west: bounds.getWest(),
          };

          console.log('ðŸ—ºï¸ Map moved, reloading data for new viewport');
          loadMapData(boundsObj);
        }
      }, 500); // Wait 500ms after user stops moving the map
    };

    // Listen for map move and zoom events
    map.current.on('moveend', handleMapMove);
    map.current.on('zoomend', handleMapMove);

    // Cleanup
    return () => {
      clearTimeout(moveTimeout);
      if (map.current) {
        map.current.off('moveend', handleMapMove);
        map.current.off('zoomend', handleMapMove);
      }
    };
  }, [loadMapData]);
  */

  // Reload data when data sources change (but use cache if available)
  useEffect(() => {
    console.log('ðŸ”„ Data sources changed, checking cache...');
    // Clear existing data first
    setProperties([]);
    setListings([]);
    setRentals([]);
    // Then load new data (will use cache if available)
    loadMapData();
  }, [dataSources.sold, dataSources.forSale, dataSources.rentals, loadMapData]);

  // Initial data load when component mounts
  useEffect(() => {
    const timer = setTimeout(() => {
      if (!properties.length && !listings.length && !rentals.length) {
        console.log('ðŸ™ï¸ Loading initial data...');
        // Load data for current viewport or fallback to Dublin
        loadMapData();
      }
    }, 1000); // Wait 1 second for map to initialize

    return () => clearTimeout(timer);
  }, [loadMapData]); // Added loadMapData dependency

  // Add loading indicator with progress
  useEffect(() => {
    if (loading && map.current) {
      // Add loading indicator to map
      const loadingEl = document.createElement('div');
      loadingEl.id = 'map-loading-indicator';
      loadingEl.style.cssText = `
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(17, 24, 39, 0.95);
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        font-size: 14px;
        color: white;
        z-index: 1000;
        min-width: 200px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      `;
      
      const updateProgress = () => {
        loadingEl.innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <span style="font-weight: 500;">Loading properties...</span>
              <span style="font-weight: 600; color: #60a5fa;">${loadingProgress}%</span>
            </div>
            <div style="width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
              <div style="width: ${loadingProgress}%; height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); transition: width 0.3s ease; border-radius: 3px;"></div>
            </div>
          </div>
        `;
      };
      
      updateProgress();
      map.current.getContainer().appendChild(loadingEl);
      
      // Update progress periodically
      const interval = setInterval(updateProgress, 100);

      return () => {
        clearInterval(interval);
        const existing = document.getElementById('map-loading-indicator');
        if (existing) existing.remove();
      };
    } else {
      // Remove loading indicator
      const existing = document.getElementById('map-loading-indicator');
      if (existing) existing.remove();
    }
  }, [loading, loadingProgress]);

  // Get available years from the data
  const availableYears = useMemo(() => {
    const years = new Set<number>();

    // Include years from properties (sold dates)
    properties.forEach(item => {
      if (item.soldDate) {
        years.add(new Date(item.soldDate).getFullYear());
      }
    });

    // For now, we'll only use sold dates from properties
    // Listings and rentals use scrapedAt which isn't meaningful for year filtering

    return Array.from(years).sort((a, b) => b - a); // Most recent first
  }, [properties]);

  // Filter properties based on difference and time filters
  const filteredProperties = useMemo(() => {
    let filtered = properties;
    
    // Apply recent filter (takes priority)
    if (recentFilter) {
      const now = new Date();
      filtered = filtered.filter(p => {
        if (!p.soldDate) return false;
        const soldDate = new Date(p.soldDate);
        
        if (recentFilter === '6m') {
          const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
          return soldDate >= sixMonthsAgo;
        } else if (recentFilter === '12m') {
          const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
          return soldDate >= oneYearAgo;
        }
        return true;
      });
    }
    // Apply hierarchical year/quarter/month filter
    else if (selectedYear !== null) {
      filtered = filtered.filter(p => {
        if (!p.soldDate) return false;
        const soldDate = new Date(p.soldDate);
        const year = soldDate.getFullYear();
        const month = soldDate.getMonth();
        
        // Year must match
        if (year !== selectedYear) return false;
        
        // If quarter is selected, filter by quarter
        if (selectedQuarter !== null) {
          const quarterMonths = QUARTER_MONTHS[selectedQuarter];
          if (!quarterMonths.includes(month)) return false;
          
          // If month is selected, filter by specific month
          if (selectedMonth !== null && month !== selectedMonth) return false;
        }
        
        return true;
      });
    }
    
    // Apply difference filter
    if (differenceFilter !== null) {
      filtered = filtered.filter(p => {
        if (!p.askingPrice || p.askingPrice === 0) return false;
        const percentDiff = ((p.soldPrice - p.askingPrice) / p.askingPrice) * 100;
        return percentDiff >= differenceFilter;
      });
    }
    
    // Apply bedroom filter
    if (bedsFilter !== null) {
      filtered = filtered.filter(p => {
        if (bedsFilter === 5) return (p.beds || 0) >= 5; // 5+ beds
        return p.beds === bedsFilter;
      });
    }
    
    // Apply property type filter
    // Property type filter (support both simple and enhanced)
    if (selectedPropertyTypes.length > 0) {
      filtered = filtered.filter(p =>
        selectedPropertyTypes.some(type => p.propertyType?.toLowerCase().includes(type.toLowerCase()))
      );
    } else if (propertyTypeFilter !== null) {
      filtered = filtered.filter(p =>
        p.propertyType?.toLowerCase().includes(propertyTypeFilter.toLowerCase())
      );
    }

    // Distance band filter
    if (selectedDistanceBands.length > 0) {
      filtered = filtered.filter(p => {
        if (!p.latitude || !p.longitude) return false;
        const distanceContext = getDistanceContext(p.latitude, p.longitude);
        return selectedDistanceBands.includes(distanceContext.band);
      });
    }
    
    // Apply price range filter
    if (minPrice !== null) {
      filtered = filtered.filter(p => p.soldPrice >= minPrice);
    }
    if (maxPrice !== null) {
      filtered = filtered.filter(p => p.soldPrice <= maxPrice);
    }
    
    // Apply area filter
    if (minArea !== null) {
      filtered = filtered.filter(p => (p.areaSqm || 0) >= minArea);
    }
    if (maxArea !== null) {
      filtered = filtered.filter(p => (p.areaSqm || 0) <= maxArea);
    }
    
    // Apply yield filter
    if (yieldFilter !== null) {
      filtered = filtered.filter(p => {
        const y = p.yieldEstimate?.grossYield;
        return y !== undefined && y !== null && y >= yieldFilter;
      });
    }

    // Apply saved only filter
    if (dataSources.savedOnly && user?.tier === 'premium') {
      filtered = filtered.filter(p => isSaved(p.address, 'listing'));
    }

    return filtered;
  }, [properties, dataSources, user, differenceFilter, selectedYear, selectedQuarter, selectedMonth, recentFilter, bedsFilter, propertyTypeFilter, selectedPropertyTypes, selectedDistanceBands, minPrice, maxPrice, minArea, maxArea, yieldFilter]);

  // Helper to clear time filters
  const clearTimeFilters = () => {
    setSelectedYear(null);
    setSelectedQuarter(null);
    setSelectedMonth(null);
    setRecentFilter(null);
    setTimeFilter(null);
  };

  // Filter listings based on time filters (using scrapedAt date)
  const filteredListings = useMemo(() => {
    let filtered = listings;
    
    // Apply recent filter
    if (recentFilter) {
      const now = new Date();
      filtered = filtered.filter(l => {
        if (!l.scrapedAt) return false;
        const scrapedDate = new Date(l.scrapedAt);
        
        if (recentFilter === '6m') {
          const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
          return scrapedDate >= sixMonthsAgo;
        } else if (recentFilter === '12m') {
          const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
          return scrapedDate >= oneYearAgo;
        }
        return true;
      });
    }
    // Apply year/quarter/month filter
    else if (selectedYear !== null) {
      filtered = filtered.filter(l => {
        if (!l.scrapedAt) return false;
        const scrapedDate = new Date(l.scrapedAt);
        const year = scrapedDate.getFullYear();
        const month = scrapedDate.getMonth();
        
        if (year !== selectedYear) return false;
        
        if (selectedQuarter !== null) {
          const quarterMonths = QUARTER_MONTHS[selectedQuarter];
          if (!quarterMonths.includes(month)) return false;
          
          if (selectedMonth !== null && month !== selectedMonth) return false;
        }
        
        return true;
      });
    }
    
    // Apply bedroom filter
    if (bedsFilter !== null) {
      filtered = filtered.filter(l => {
        if (bedsFilter === 5) return (l.beds || 0) >= 5; // 5+ beds
        return l.beds === bedsFilter;
      });
    }
    
    // Apply property type filter
    // Property type filter (support both simple and enhanced)
    if (selectedPropertyTypes.length > 0) {
      filtered = filtered.filter(l =>
        selectedPropertyTypes.some(type => l.propertyType?.toLowerCase().includes(type.toLowerCase()))
      );
    } else if (propertyTypeFilter !== null) {
      filtered = filtered.filter(l =>
        l.propertyType?.toLowerCase().includes(propertyTypeFilter.toLowerCase())
      );
    }

    // Distance band filter
    if (selectedDistanceBands.length > 0) {
      filtered = filtered.filter(l => {
        if (!l.latitude || !l.longitude) return false;
        const distanceContext = getDistanceContext(l.latitude, l.longitude);
        return selectedDistanceBands.includes(distanceContext.band);
      });
    }
    
    // Apply price range filter
    if (minPrice !== null) {
      filtered = filtered.filter(l => l.askingPrice >= minPrice);
    }
    if (maxPrice !== null) {
      filtered = filtered.filter(l => l.askingPrice <= maxPrice);
    }
    
    // Apply area filter
    if (minArea !== null) {
      filtered = filtered.filter(l => (l.areaSqm || 0) >= minArea);
    }
    if (maxArea !== null) {
      filtered = filtered.filter(l => (l.areaSqm || 0) <= maxArea);
    }
    
    // Apply yield filter
    if (yieldFilter !== null) {
      filtered = filtered.filter(l => {
        const y = l.yieldEstimate?.grossYield;
        return y !== undefined && y !== null && y >= yieldFilter;
      });
    }

    // Apply saved only filter
    if (dataSources.savedOnly && user?.tier === 'premium') {
      filtered = filtered.filter(l => isSaved(l.address, 'listing'));
    }

    return filtered;
  }, [listings, dataSources, user, recentFilter, selectedYear, selectedQuarter, selectedMonth, bedsFilter, propertyTypeFilter, selectedPropertyTypes, selectedDistanceBands, minPrice, maxPrice, minArea, maxArea, yieldFilter]);

  // Filter rentals based on filters
  const filteredRentals = useMemo(() => {
    let filtered = rentals;
    
    // Apply bedroom filter
    if (bedsFilter !== null) {
      filtered = filtered.filter(r => {
        if (bedsFilter === 5) return (r.beds || 0) >= 5; // 5+ beds
        return r.beds === bedsFilter;
      });
    }
    
    // Apply property type filter (support both simple and enhanced)
    if (selectedPropertyTypes.length > 0) {
      filtered = filtered.filter(r =>
        selectedPropertyTypes.some(type => r.propertyType?.toLowerCase().includes(type.toLowerCase()))
      );
    } else if (propertyTypeFilter !== null) {
      filtered = filtered.filter(r =>
        r.propertyType?.toLowerCase().includes(propertyTypeFilter.toLowerCase())
      );
    }

    // Distance band filter
    if (selectedDistanceBands.length > 0) {
      filtered = filtered.filter(r => {
        if (!r.latitude || !r.longitude) return false;
        const distanceContext = getDistanceContext(r.latitude, r.longitude);
        return selectedDistanceBands.includes(distanceContext.band);
      });
    }

    // Apply price range filter (monthly rent)
    if (minPrice !== null) {
      filtered = filtered.filter(r => r.monthlyRent >= minPrice);
    }
    if (maxPrice !== null) {
      filtered = filtered.filter(r => r.monthlyRent <= maxPrice);
    }
    
    // Apply area filter
    if (minArea !== null) {
      filtered = filtered.filter(r => (r.areaSqm || 0) >= minArea);
    }
    if (maxArea !== null) {
      filtered = filtered.filter(r => (r.areaSqm || 0) <= maxArea);
    }

    // Apply saved only filter
    if (dataSources.savedOnly && user?.tier === 'premium') {
      filtered = filtered.filter(r => isSaved(r.address, 'rental'));
    }

    return filtered;
  }, [rentals, dataSources, user, bedsFilter, propertyTypeFilter, selectedPropertyTypes, selectedDistanceBands, minPrice, maxPrice, minArea, maxArea]);

  // Get active data based on selected data sources
  const activeData = useMemo(() => {
    const listingsData = filteredListings.map(l => ({
      ...l,
      // Normalize for map display
      price: l.askingPrice,
      soldPrice: 0, // Not applicable
      soldDate: l.scrapedAt, // Use scrapedAt for listings
      overUnderPercent: 0, // Not applicable
      isListing: true,
      isRental: false,
    }));
    
    const soldData = filteredProperties.map(p => ({
      ...p,
      price: p.soldPrice,
      isListing: false,
      isRental: false,
    }));
    
    const rentalsData = filteredRentals.map(r => ({
      ...r,
      // Normalize for map display
      price: r.monthlyRent,
      soldPrice: 0, // Not applicable
      soldDate: r.scrapedAt, // Use scrapedAt for rentals
      overUnderPercent: 0, // Not applicable
      askingPrice: r.monthlyRent, // Use monthly rent as the "price"
      pricePerSqm: r.areaSqm ? Math.round(r.monthlyRent / r.areaSqm) : 0,
      isListing: false,
      isRental: true,
    }));
    
    // Combine based on selected sources
    const result: typeof soldData = [];
    if (dataSources.sold) result.push(...soldData);
    if (dataSources.forSale) result.push(...listingsData);
    if (dataSources.rentals) result.push(...rentalsData);
    
    return result;
  }, [dataSources, filteredListings, filteredProperties, filteredRentals]);

  // Count active filters for badge display
  const activeFilterCount = useMemo(() => {
    let count = 0;
    if (selectedYear !== null) count++;
    if (selectedQuarter !== null) count++;
    if (selectedMonth !== null) count++;
    if (recentFilter !== null) count++;
    if (differenceFilter !== null) count++;
    if (bedsFilter !== null) count++;
    if (propertyTypeFilter !== null) count++;
    if (selectedPropertyTypes.length > 0) count++;
    if (selectedDistanceBands.length > 0) count++;
    if (minPrice !== null) count++;
    if (maxPrice !== null) count++;
    if (minArea !== null) count++;
    if (maxArea !== null) count++;
    if (yieldFilter !== null) count++;
    return count;
  }, [selectedYear, selectedQuarter, selectedMonth, recentFilter, differenceFilter, bedsFilter, propertyTypeFilter, selectedPropertyTypes, selectedDistanceBands, minPrice, maxPrice, minArea, maxArea, yieldFilter]);

  // Calculate filtered stats for the selected time period (sold properties)
  const filteredStats = useMemo(() => {
    // Get properties with valid pricePerSqm for the filtered set
    const withPricePerSqm = filteredProperties.filter(p => p.pricePerSqm && p.pricePerSqm > 0);
    
    if (withPricePerSqm.length === 0) {
      return { avgPricePerSqm: 0, percentChange: null, isFiltered: false };
    }
    
    const filteredAvg = Math.round(
      withPricePerSqm.reduce((sum, p) => sum + (p.pricePerSqm || 0), 0) / withPricePerSqm.length
    );
    
    // Check if we have an active time filter
    const isFiltered = selectedYear !== null || recentFilter !== null;
    
    // Calculate percentage change vs overall average
    let percentChange: number | null = null;
    if (isFiltered && stats.avgPricePerSqm > 0) {
      percentChange = ((filteredAvg - stats.avgPricePerSqm) / stats.avgPricePerSqm) * 100;
    }
    
    return { avgPricePerSqm: filteredAvg, percentChange, isFiltered };
  }, [filteredProperties, selectedYear, recentFilter, stats.avgPricePerSqm]);

  // Calculate filtered stats for listings (for sale)
  const filteredListingStats = useMemo(() => {
    const withPricePerSqm = filteredListings.filter(l => l.pricePerSqm && l.pricePerSqm > 0);
    
    if (withPricePerSqm.length === 0) {
      return { avgPricePerSqm: 0, medianPrice: 0 };
    }
    
    const avgPricePerSqm = Math.round(
      withPricePerSqm.reduce((sum, l) => sum + (l.pricePerSqm || 0), 0) / withPricePerSqm.length
    );
    
    const prices = filteredListings.map(l => l.askingPrice).sort((a, b) => a - b);
    const medianPrice = prices[Math.floor(prices.length / 2)] || 0;
    
    return { avgPricePerSqm, medianPrice };
  }, [filteredListings]);

  // Helper to get current time filter description
  const getTimeFilterLabel = (): string => {
    if (timeFilter === 'today') return 'Today';
    if (timeFilter === 'thisWeek') return 'This Week';
    if (timeFilter === 'thisMonth') return 'This Month';
    if (timeFilter === 'lastWeek') return 'Last Week';
    if (timeFilter === 'lastMonth') return 'Last Month';
    if (recentFilter === '6m') return 'Last 6 months';
    if (recentFilter === '12m') return 'Last 12 months';
    if (selectedYear === null) return 'All Time';

    let label = selectedYear.toString();
    if (selectedQuarter !== null) {
      label += ` Q${selectedQuarter}`;
      if (selectedMonth !== null) {
        label = `${MONTH_NAMES[selectedMonth]} ${selectedYear}`;
      }
    }
    return label;
  };

  // Initialize map
  useEffect(() => {
    if (!mapContainer.current || map.current) return;

    const initializeMap = async (styleUrl: string = 'mapbox://styles/mapbox/dark-v11') => {
      if (!mapContainer.current) return;

      try {
        map.current = new mapboxgl.Map({
          container: mapContainer.current,
          style: styleUrl,
          center: [-6.26, 53.35], // Dublin
          zoom: 11,
          pitch: 0,
        });

        const navControl = new mapboxgl.NavigationControl();
        map.current.addControl(navControl, 'top-right');

        // Store reference to nav control for hiding/showing
        (map.current as any).navControl = navControl;

        map.current.on('load', () => {
          // Initialize spiderfy manager
          if (map.current) {
            spiderfyManager.current = new SpiderfyManager(map.current, handleSpiderFeatureClick);
            spiderfyManager.current.initializeLayers();
          }
          setMapReady(true);
        });

        map.current.on('error', (e) => {
          console.error('Mapbox error:', e);
          setMapError('Map failed to load. This may be due to network issues or an invalid access token.');
        });


      } catch (error) {
        console.error('Failed to initialize map:', error);
        setMapError('Failed to initialize map. Please check your internet connection and try again.');
      }
    };

    initializeMap();

    // Track zoom level for legend display
    if (map.current) {
      (map.current as mapboxgl.Map).on('zoom', () => {
        if (map.current) {
          setZoomLevel(map.current.getZoom());
        }
      });
    }

    return () => {
      spiderfyManager.current?.cleanup();
      spiderfyManager.current = null;
      map.current?.remove();
      map.current = null;
    };
  }, [handleSpiderFeatureClick]);


  // Hide navigation controls on mobile when property panel is open
  useEffect(() => {
    if (!map.current) return;
    
    const isMobile = window.innerWidth < 768;
    const hasPropertyOpen = selectedProperty || selectedListing || selectedRental;
    
    if (isMobile && hasPropertyOpen) {
      // Hide navigation control on mobile when property is selected
      const navControlContainer = document.querySelector('.mapboxgl-ctrl-top-right');
      if (navControlContainer) {
        (navControlContainer as HTMLElement).style.display = 'none';
      }
    } else {
      // Show navigation control
      const navControlContainer = document.querySelector('.mapboxgl-ctrl-top-right');
      if (navControlContainer) {
        (navControlContainer as HTMLElement).style.display = 'block';
      }
    }
  }, [selectedProperty, selectedListing, selectedRental]);

  // Setup map layers based on view mode and data source
  useEffect(() => {
    if (!mapReady || !map.current || activeData.length === 0) return;

    // Helper function to setup layers - may need to retry if style not loaded
    const setupLayers = () => {
      if (!map.current || !map.current.isStyleLoaded()) {
        // Style not ready, retry in 100ms
        setTimeout(setupLayers, 100);
        return;
      }
      
      doSetupLayers();
    };
    
    const doSetupLayers = () => {
    const geojson: GeoJSON.FeatureCollection = {
      type: 'FeatureCollection',
      features: activeData.map(item => {
        const isListing = item.isListing;
        const isRental = item.isRental;
        const soldPrice = (isListing || isRental) ? 0 : item.soldPrice;
        const askingPrice = item.askingPrice || 0;
        const priceDiff = (isListing || isRental) ? 0 : (askingPrice ? soldPrice - askingPrice : 0);
        const priceDiffPercent = (isListing || isRental) ? 0 : (askingPrice ? Math.round((priceDiff / askingPrice) * 100) : 0);
        
        return {
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: [item.longitude!, item.latitude!],
          },
          properties: {
            id: item.address,
            sourceUrl: item.sourceUrl,
            address: item.address,
            soldPrice: soldPrice,
            askingPrice: askingPrice,
            price: soldPrice || askingPrice, // Unified price field
            pricePerSqm: item.pricePerSqm || 0,
            priceDiff,
            priceDiffPercent,
            beds: item.beds,
            baths: item.baths,
            propertyType: item.propertyType,
            soldDate: (isListing || isRental) ? '' : item.soldDate,
            berRating: (isListing || isRental) ? (item as any).berRating : null,
            isListing: isListing,
            isRental: isRental,
            // Rental-specific properties
            monthlyRent: isRental ? (item as any).monthlyRent : null,
            furnishing: isRental ? (item as any).furnishing : null,
            dublinPostcode: isRental ? (item as any).dublinPostcode : null,
            rentPerSqm: isRental ? (item as any).rentPerSqm : null,
            rentPerBed: isRental ? (item as any).rentPerBed : null,
          },
        };
      }),
    };

    // Remove existing layers/sources
    // Collapse spider when view/data changes
    spiderfyManager.current?.collapse();
    
    if (!map.current) return;
    
    // Remove existing layers first
    const layersToRemove = ['clusters', 'cluster-count', 'unclustered-point', 'properties-points', 'selected-property-point', 'selected-property-star', 'planning-radius-fill', 'planning-radius-outline', 'planning-center-marker'];
    layersToRemove.forEach(layer => {
      try {
        if (map.current?.getLayer(layer)) {
          map.current.removeLayer(layer);
        }
      } catch (error) {
        // Layer might not exist, continue silently
      }
    });

    // Then remove sources
    const sourcesToRemove = ['properties', 'properties-clustered', 'planning-radius', 'planning-center'];
    sourcesToRemove.forEach(source => {
      try {
        if (map.current?.getSource(source)) {
          map.current.removeSource(source);
        }
      } catch (error) {
        // Source might not exist, continue silently
      }
    });

    if (viewMode === 'clusters') {
      // Add clustered source
      map.current.addSource('properties-clustered', {
        type: 'geojson',
        data: geojson,
        cluster: true,
        clusterMaxZoom: 14,
        clusterRadius: 60,
      });

      // Cluster circles - sized by count
      map.current.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'properties-clustered',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': [
            'step',
            ['get', 'point_count'],
            '#3B82F6',  // Blue for small clusters
            10, '#22C55E', // Green for medium
            50, '#FACC15', // Yellow for large
            100, '#F97316', // Orange for very large
            200, '#EF4444', // Red for huge
          ],
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            20,
            10, 25,
            50, 35,
            100, 45,
            200, 55,
          ],
          'circle-stroke-width': 3,
          'circle-stroke-color': 'rgba(255, 255, 255, 0.3)',
        },
      });

      // Cluster count label
      map.current.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'properties-clustered',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': '{point_count_abbreviated}',
          'text-font': ['DIN Pro Bold', 'Arial Unicode MS Bold'],
          'text-size': 14,
        },
        paint: {
          'text-color': '#ffffff',
        },
      });

      // Individual unclustered points - different colors for sold vs for sale vs rentals
      map.current.addLayer({
        id: 'unclustered-point',
        type: 'circle',
        source: 'properties-clustered',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-radius': 8,
          'circle-color': activeSourceCount > 1 
            ? [
                'case',
                ['==', ['get', 'isRental'], true],
                '#A855F7', // Purple for rentals
                ['==', ['get', 'isListing'], true],
                '#F43F5E', // Rose/hot pink for listings (for sale)
                '#FFFFFF', // White for sold properties
              ]
            : dataSources.rentals
            ? '#A855F7' // Purple for rentals
            : dataSources.forSale
            ? '#F43F5E' // Rose/hot pink for listings
            : [
                // Price-based gradient for sold only
                'interpolate',
                ['linear'],
                ['get', 'pricePerSqm'],
                2000, '#22C55E',
                4000, '#3B82F6',
                6000, '#FACC15',
                8000, '#F97316',
                10000, '#EF4444',
              ],
          'circle-stroke-width': 2,
          'circle-stroke-color': activeSourceCount > 1 
            ? [
                'case',
                ['==', ['get', 'isRental'], true],
                '#ffffff',
                ['==', ['get', 'isListing'], true],
                '#ffffff',
                '#374151', // Dark gray stroke for white dots
              ]
            : '#ffffff',
        },
      });

      // Click on cluster to zoom
      map.current.on('click', 'clusters', (e) => {
        const features = map.current?.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        if (!features?.length) return;
        const clusterId = features[0].properties?.cluster_id;
        const source = map.current?.getSource('properties-clustered') as mapboxgl.GeoJSONSource;
        source.getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err || !map.current) return;
          const geometry = features[0].geometry as GeoJSON.Point;
          map.current.easeTo({
            center: geometry.coordinates as [number, number],
            zoom: zoom || 14,
          });
        });
      });

      // Click on unclustered point - with spiderfy support
      map.current.on('click', 'unclustered-point', (e) => {
        if (!e.features || !e.features[0]) return;
        
        // Prevent reopening if we just closed a card
        if (isClosingRef.current) {
          console.log('Ignoring click - card is being closed');
          return;
        }

        const clickedFeature = e.features[0];
        const clickedGeometry = clickedFeature.geometry as GeoJSON.Point;
        const clickedCoords = clickedGeometry.coordinates as [number, number];

        // If spider is expanded and user clicks the center point, collapse it
        if (spiderfyManager.current?.isAtCenter(clickedCoords)) {
          spiderfyManager.current.collapse();
          return;
        }

        // Query ALL features at this pixel location
        const allFeatures = map.current?.queryRenderedFeatures(e.point, {
          layers: ['unclustered-point']
        });

        // Find features with identical coordinates (within small tolerance)
        const tolerance = 0.000001;
        const overlappingRaw = allFeatures?.filter(f => {
          const geom = f.geometry as GeoJSON.Point;
          return Math.abs(geom.coordinates[0] - clickedCoords[0]) < tolerance &&
                 Math.abs(geom.coordinates[1] - clickedCoords[1]) < tolerance;
        }) || [];

        // Deduplicate by unique ID (Mapbox can return same feature multiple times from tile overlaps)
        const seenIds = new Set<string>();
        const overlapping = overlappingRaw.filter(f => {
          const id = f.properties?.id || f.properties?.address;
          if (seenIds.has(id)) return false;
          seenIds.add(id);
          return true;
        });

        if (overlapping.length > 1) {
          // Multiple properties at same location - trigger spiderfy
          spiderfyManager.current?.expand(clickedCoords, overlapping);
        } else {
          // Single property - show details and zoom to focus on it
          const props = clickedFeature.properties;
          if (props?.isRental) {
            // Find the full rental object
            const fullRental = rentals.find(r => r.address === props?.address);
            if (fullRental && fullRental.longitude && fullRental.latitude) {
              setSelectedRental(fullRental);
            }
            setSelectedProperty(null);
            setSelectedListing(null);
          } else if (props?.isListing) {
            // Find the full listing object
            const fullListing = listings.find(l => l.address === props?.address);
            if (fullListing && fullListing.longitude && fullListing.latitude) {
              setSelectedListing(fullListing);
            }
            setSelectedProperty(null);
            setSelectedRental(null);
          } else {
            // Find the full property object
            const fullProperty = properties.find(p => p.address === props?.address);
          if (fullProperty && fullProperty.longitude && fullProperty.latitude) {
            setSelectedProperty(fullProperty);
            setActiveTab('details'); // Reset to details tab when selecting new property
            if (isMobile) setShowFilters(false); // Close filters on mobile when selecting property
          }
            setSelectedListing(null);
            setSelectedRental(null);
          }
        }
      });
      
      // Click elsewhere on map to collapse spider
      // Note: This handler fires AFTER layer-specific handlers, so we need to be careful
      map.current.on('click', (e) => {
        // FIRST: Check if click was on spider markers or legs - these have highest priority
        if (spiderfyManager.current?.isClickOnSpider(e.point)) {
          return; // Don't collapse if clicking on spider menu
        }
        
        // SECOND: Check if click was on clusters or unclustered points - if so, let those handlers deal with it
        const clickedFeatures = map.current?.queryRenderedFeatures(e.point, {
          layers: ['clusters', 'unclustered-point']
        });
        if (clickedFeatures && clickedFeatures.length > 0) {
          return; // Let the layer-specific handlers handle this
        }
        
        // Only collapse if clicking on empty map area
        spiderfyManager.current?.collapse();
      });

      // Cursor changes
      ['clusters', 'unclustered-point'].forEach(layer => {
        map.current?.on('mouseenter', layer, () => {
          if (map.current) map.current.getCanvas().style.cursor = 'pointer';
        });
        map.current?.on('mouseleave', layer, () => {
          if (map.current) map.current.getCanvas().style.cursor = '';
        });
      });

    } else if (viewMode === 'price') {
      // By sold price view
      map.current.addSource('properties', {
        type: 'geojson',
        data: geojson,
      });

      map.current.addLayer({
        id: 'properties-points',
        type: 'circle',
        source: 'properties',
        paint: {
          'circle-radius': [
            'interpolate',
            ['linear'],
            ['zoom'],
            9, 4,
            14, 10,
          ],
          'circle-color': [
            'interpolate',
            ['linear'],
            ['get', 'price'], // Use unified price field (soldPrice for sold, askingPrice for listings)
            200000, '#22C55E',
            400000, '#3B82F6',
            600000, '#FACC15',
            800000, '#F97316',
            1000000, '#EF4444',
          ],
          'circle-opacity': 0.85,
          'circle-stroke-width': 1,
          'circle-stroke-color': '#ffffff',
        },
      });

      // Add selected property highlight layer (on top of regular properties)
      const currentProperty = selectedProperty || selectedListing || selectedRental;
      console.log('Adding selected property layer for:', currentProperty?.address);
      console.log('Selected property coords:', currentProperty?.longitude, currentProperty?.latitude);
      if (currentProperty && currentProperty.longitude && currentProperty.latitude) {
        console.log('Creating selected property highlight layer for address:', currentProperty.address);
        try {
          map.current.addLayer({
            id: 'selected-property-point',
            type: 'circle',
            source: 'properties',
            filter: ['==', ['get', 'address'], currentProperty.address],
            paint: {
              'circle-radius': [
                'interpolate',
                ['linear'],
                ['zoom'],
                9, 8,  // Larger than regular markers
                14, 16,
              ],
              'circle-color': '#9333EA', // Purple/magenta for selected
              'circle-opacity': 1.0,
              'circle-stroke-width': 3,
              'circle-stroke-color': '#ffffff',
              // Add a subtle pulse effect
              'circle-stroke-opacity': 0.8,
            },
          });
          console.log('Selected property highlight layer created successfully');
        } catch (error) {
          console.error('Error creating selected property layer:', error);
        }
      } else {
        console.log('Skipping selected property layer - missing coords or no selection');
      }

      setupPointClickHandler('properties-points');

    } else if (viewMode === 'difference') {
      // Difference view - color by over/under asking
      map.current.addSource('properties', {
        type: 'geojson',
        data: geojson,
      });

      map.current.addLayer({
        id: 'properties-points',
        type: 'circle',
        source: 'properties',
        paint: {
          'circle-radius': [
            'interpolate',
            ['linear'],
            ['zoom'],
            9, 5,
            14, 12,
          ],
          // Color by difference percentage: green = under asking, red = over asking
          'circle-color': [
            'interpolate',
            ['linear'],
            ['get', 'priceDiffPercent'],
            -20, '#22C55E',  // 20% under asking - bright green
            -10, '#4ADE80',  // 10% under - light green
            0, '#FACC15',    // At asking - yellow
            10, '#F97316',   // 10% over - orange
            20, '#EF4444',   // 20% over - red
          ],
          'circle-opacity': 0.9,
          'circle-stroke-width': 2,
          'circle-stroke-color': '#ffffff',
        },
      });

      // Add selected property highlight layer (on top of regular properties)
      const currentProperty = selectedProperty || selectedListing || selectedRental;
      if (currentProperty && currentProperty.longitude && currentProperty.latitude) {
        map.current.addLayer({
          id: 'selected-property-point',
          type: 'circle',
          source: 'properties',
          filter: ['==', ['get', 'address'], currentProperty.address],
          paint: {
            'circle-radius': [
              'interpolate',
              ['linear'],
              ['zoom'],
              9, 10,  // Larger than regular markers
              14, 20,
            ],
            'circle-color': '#9333EA', // Purple/magenta for selected
            'circle-opacity': 1.0,
            'circle-stroke-width': 4,
            'circle-stroke-color': '#ffffff',
            // Add a subtle pulse effect
            'circle-stroke-opacity': 0.9,
          },
        });
      }

      setupPointClickHandler('properties-points');
    }

    function setupPointClickHandler(layerId: string) {
      map.current?.on('click', layerId, (e) => {
        if (!e.features || !e.features[0]) return;
        
        // Prevent reopening if we just closed a card
        if (isClosingRef.current) {
          console.log('Ignoring click - card is being closed');
          return;
        }
        
        // Check if layer still exists before processing
        if (!map.current?.getLayer(layerId)) return;
        
        const clickedFeature = e.features[0];
        const clickedGeometry = clickedFeature.geometry as GeoJSON.Point;
        const clickedCoords = clickedGeometry.coordinates as [number, number];
        
        // If spider is expanded and user clicks the center point, collapse it
        if (spiderfyManager.current?.isAtCenter(clickedCoords)) {
          spiderfyManager.current.collapse();
          return;
        }
        
        // Query ALL features at this pixel location
        const allFeatures = map.current?.queryRenderedFeatures(e.point, {
          layers: [layerId]
        });
        
        // Find features with identical coordinates
        const tolerance = 0.000001;
        const overlappingRaw = allFeatures?.filter(f => {
          const geom = f.geometry as GeoJSON.Point;
          return Math.abs(geom.coordinates[0] - clickedCoords[0]) < tolerance &&
                 Math.abs(geom.coordinates[1] - clickedCoords[1]) < tolerance;
        }) || [];
        
        // Deduplicate by unique ID (Mapbox can return same feature multiple times from tile overlaps)
        const seenIds = new Set<string>();
        const overlapping = overlappingRaw.filter(f => {
          const id = f.properties?.id || f.properties?.address;
          if (seenIds.has(id)) return false;
          seenIds.add(id);
          return true;
        });
        
        if (overlapping.length > 1) {
          // Multiple properties at same location - trigger spiderfy
          spiderfyManager.current?.expand(clickedCoords, overlapping);
        } else {
          // Single property - show details as normal
          const props = clickedFeature.properties;
          if (props?.isRental) {
            // Find the full rental object
            const fullRental = rentals.find(r => r.address === props?.address);
            if (fullRental) {
              setSelectedRental(fullRental);
            }
            setSelectedProperty(null);
            setSelectedListing(null);
          } else if (props?.isListing) {
            // Find the full listing object
            const fullListing = listings.find(l => l.address === props?.address);
            if (fullListing) {
              setSelectedListing(fullListing);
            }
            setSelectedProperty(null);
            setSelectedRental(null);
          } else {
            // Find the full property object
            const fullProperty = properties.find(p => p.address === props?.address);
            if (fullProperty) {
              setSelectedProperty(fullProperty);
            }
            setSelectedListing(null);
            setSelectedRental(null);
          }
        }
      });
      
      // Click elsewhere on map to collapse spider (for price/difference view modes)
      // Note: This handler fires AFTER layer-specific handlers, so we need to be careful
      map.current?.on('click', (e) => {
        // Check if layer still exists before querying
        if (!map.current?.getLayer(layerId)) return;
        
        // FIRST: Check if click was on spider markers or legs - these have highest priority
        if (spiderfyManager.current?.isClickOnSpider(e.point)) {
          return; // Don't collapse if clicking on spider menu
        }
        
        // SECOND: Check if click was on the layer - if so, let the layer-specific handler deal with it
        const clickedFeatures = map.current?.queryRenderedFeatures(e.point, {
          layers: [layerId]
        });
        if (clickedFeatures && clickedFeatures.length > 0) {
          return; // Let the layer-specific handler handle this
        }
        
        // Only collapse if clicking on empty map area
        spiderfyManager.current?.collapse();
      });

      map.current?.on('mouseenter', layerId, () => {
        if (map.current?.getLayer(layerId)) {
          map.current.getCanvas().style.cursor = 'pointer';
        }
      });
      map.current?.on('mouseleave', layerId, () => {
        if (map.current) map.current.getCanvas().style.cursor = '';
      });
    }

    // Add star icon for selected property in amenities mode (using built-in Mapbox Maki icon)
    // We'll use the 'star' icon which should be available in the default Mapbox style

    // Add amenities sources and layers
    if (!map.current.getSource('amenities')) {
      map.current.addSource('amenities', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] }
      });

      // Heavy rail layer (DART/Luas) - larger, more prominent
      map.current.addLayer({
        id: 'amenities-heavy-rail',
        type: 'symbol',
        source: 'amenities',
        filter: ['==', ['get', 'isHeavyRail'], true],
        layout: {
          'icon-image': ['get', 'icon'], // Mapbox Maki icon
          'icon-size': 1.8, // Even larger for prominence in amenities mode
          'icon-allow-overlap': true,
          'text-field': ['get', 'name'],
          'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
          'text-size': 12,
          'text-anchor': 'top',
          'text-offset': [0, 2],
          'visibility': 'none', // Hidden initially
        },
        paint: {
          'icon-color': '#3B82F6', // Blue for transport
          'text-color': '#ffffff',
          'text-halo-color': '#000000',
          'text-halo-width': 2,
        }
      });

      // Regular amenities layer - more prominent in amenities mode
      map.current.addLayer({
        id: 'amenities-regular',
        type: 'symbol',
        source: 'amenities',
        filter: ['!=', ['get', 'isHeavyRail'], true],
        layout: {
          'icon-image': ['get', 'icon'],
          'icon-size': 1.3, // Larger than normal for better visibility
          'icon-allow-overlap': true, // Allow overlap for better visibility
          'text-field': ['get', 'name'],
          'text-font': ['Open Sans Semibold', 'Arial Unicode MS Regular'],
          'text-size': 11,
          'text-anchor': 'top',
          'text-offset': [0, 1.5],
          'visibility': 'none', // Hidden initially
        },
        paint: {
          // Color by category - brighter colors for better visibility
          'icon-color': [
            'match',
            ['get', 'category'],
            'public_transport', '#3B82F6', // Blue
            'education', '#A855F7',         // Purple
            'healthcare', '#EF4444',        // Red
            'shopping', '#10B981',          // Green
            'leisure', '#F59E0B',           // Orange
            'services', '#6B7280',          // Gray
            '#FFFFFF' // Default
          ],
          'text-color': '#ffffff',
          'text-halo-color': '#000000',
          'text-halo-width': 1.5,
        }
      });

      // Add route source and layer
      if (!map.current.getSource('route')) {
        map.current.addSource('route', {
          type: 'geojson',
          data: { type: 'FeatureCollection', features: [] }
        });

        map.current.addLayer({
          id: 'route-line',
          type: 'line',
          source: 'route',
          paint: {
            'line-color': '#3B82F6',
            'line-width': 6,
            'line-opacity': 0.9,
          }
        }, 'amenities-regular'); // Add above amenity layers
      }

      // Amenity click handlers
      map.current.on('click', 'amenities-heavy-rail', (e) => {
        if (!e.features?.[0]) return;
        handleAmenityClick(e.features[0]);
      });

      map.current.on('click', 'amenities-regular', (e) => {
        if (!e.features?.[0]) return;
        handleAmenityClick(e.features[0]);
      });

      // Amenity hover handlers
      ['amenities-heavy-rail', 'amenities-regular'].forEach(layerId => {
        map.current?.on('mouseenter', layerId, () => {
          if (map.current?.getLayer(layerId)) {
            map.current.getCanvas().style.cursor = 'pointer';
          }
        });
        map.current?.on('mouseleave', layerId, () => {
          if (map.current) map.current.getCanvas().style.cursor = '';
        });
      });
    }

    function handleAmenityClick(feature: any) {
      const props = feature.properties;
      const amenity = amenities.find(a => a.id === props.id);

      if (amenity) {
        // Track amenity click
        analytics.amenityClicked(amenity.type, amenity.name);

        setSelectedAmenity(amenity);

        // Create popup with amenity details
        if (map.current) {
          new mapboxgl.Popup()
            .setLngLat([amenity.longitude, amenity.latitude])
            .setHTML(createAmenityPopupHTML(amenity))
            .addTo(map.current);
        }
      }
    }

    function createAmenityPopupHTML(amenity: Amenity): string {
      return `
        <div class="amenity-popup" style="min-width: 200px;">
          <h3 style="font-weight: bold; margin-bottom: 8px;">${amenity.name}</h3>
          <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">
            ${formatCategory(amenity.category)}
          </div>
          <div style="margin-bottom: 8px;">
            <div style="font-size: 14px;">ðŸ“ ${amenity.distance}m away</div>
            <div style="font-size: 14px;">â±ï¸ ${amenity.walkingTime} min walk</div>
          </div>
          <button
            onclick="window.getDirections('${amenity.id}')"
            style="width: 100%; padding: 8px; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;"
          >
            Get Directions
          </button>
          <a
            href="https://www.google.com/maps/dir/?api=1&destination=${amenity.latitude},${amenity.longitude}"
            target="_blank"
            style="display: block; text-align: center; margin-top: 8px; font-size: 12px; color: #60a5fa;"
          >
            Open in Google Maps
          </a>
        </div>
      `;
    }
    }; // End of doSetupLayers
    

    // Start the setup process
    setupLayers();

  }, [mapReady, activeData, viewMode, dataSources, rentals, listings, properties, selectedProperty, selectedListing, selectedRental]);

  // Separate effect for planning radius (only when selected property changes)
  useEffect(() => {
    if (!mapReady || !map.current) return;

    // Remove existing planning radius layers
    const planningLayers = ['planning-radius-fill', 'planning-radius-outline', 'planning-center-marker'];
    planningLayers.forEach(layer => {
      try {
        if (map.current?.getLayer(layer)) {
          map.current.removeLayer(layer);
        }
      } catch (error) {
        // Layer might not exist
      }
    });

    const planningSources = ['planning-radius', 'planning-center'];
    planningSources.forEach(source => {
      try {
        if (map.current?.getSource(source)) {
          map.current.removeSource(source);
        }
      } catch (error) {
        // Source might not exist
      }
    });

    // Add new planning radius if a property is selected
    if (selectedProperty || selectedListing || selectedRental) {
      const currentProperty = selectedProperty || selectedListing || selectedRental;
      if (currentProperty?.latitude && currentProperty?.longitude) {
        addPlanningRadius();
        // Clear searched location when focusing on a property
        setSearchedLocation(null);
      }
    }
  }, [selectedProperty, selectedListing, selectedRental, mapReady, addPlanningRadius]);

  // Update planning radius when tab changes
  useEffect(() => {
    if (!map.current || !mapReady) return;

    // If planning tab is active and we have a selected property, ensure radius is shown
    if (activeTab === 'planning' && (selectedProperty || selectedListing || selectedRental)) {
      const currentProperty = selectedProperty || selectedListing || selectedRental;
      if (currentProperty?.latitude && currentProperty?.longitude) {
        addPlanningRadius();
      }
    } else {
      // Remove planning radius when conditions aren't met
      removePlanningRadius();
    }
  }, [activeTab, selectedProperty, selectedListing, selectedRental, mapReady]);

  // Cleanup planning radius when component unmounts (leaving map page)
  useEffect(() => {
    return () => {
      if (map.current) {
        removePlanningRadius();
      }
    };
  }, []);

  // Add/remove searched location marker
  useEffect(() => {
    if (!map.current || !mapReady) return;

    // Remove existing searched location marker
    try {
      if (map.current.getLayer('searched-location-marker-stroke')) {
        map.current.removeLayer('searched-location-marker-stroke');
      }
      if (map.current.getLayer('searched-location-marker')) {
        map.current.removeLayer('searched-location-marker');
      }
      if (map.current.getSource('searched-location-triangle')) {
        map.current.removeSource('searched-location-triangle');
      }
    } catch (error) {
      // Layer/source might not exist, ignore
    }

    // Add new marker if we have a searched location
    if (searchedLocation) {

      // Create a triangle shape pointing upward
      const trianglePoints = [];
      const center = searchedLocation.coords;
      const size = 20; // Size of the triangle

      // Triangle points: top, bottom-right, bottom-left
      trianglePoints.push([
        center[0],
        center[1] + (size / 111320) // Top point (north)
      ]);
      trianglePoints.push([
        center[0] + (size * Math.cos(Math.PI * 7/6) / 111320), // Bottom-right
        center[1] + (size * Math.sin(Math.PI * 7/6) / 111320)
      ]);
      trianglePoints.push([
        center[0] + (size * Math.cos(Math.PI * 11/6) / 111320), // Bottom-left
        center[1] + (size * Math.sin(Math.PI * 11/6) / 111320)
      ]);
      // Close the triangle
      trianglePoints.push(trianglePoints[0]);

      const triangleGeoJson = {
        type: 'Feature' as const,
        geometry: {
          type: 'Polygon' as const,
          coordinates: [trianglePoints]
        },
        properties: {}
      };

      map.current.addSource('searched-location-triangle', {
        type: 'geojson',
        data: triangleGeoJson
      });

      map.current.addLayer({
        id: 'searched-location-marker',
        type: 'fill',
        source: 'searched-location-triangle',
        paint: {
          'fill-color': '#F97316', // Orange color
          'fill-opacity': 0.9
        }
      });

      // Add a stroke/border to the triangle
      map.current.addLayer({
        id: 'searched-location-marker-stroke',
        type: 'line',
        source: 'searched-location-triangle',
        paint: {
          'line-color': '#ffffff',
          'line-width': 3,
          'line-opacity': 1
        }
      });

      console.log('Added searched location marker:', searchedLocation.name);
    }
  }, [searchedLocation, mapReady]);

  // Update amenities map layers when category filters change (debounced)
  useEffect(() => {
    if (!map.current || !amenities.length) return;

    // Debounce rapid filter changes
    const timeoutId = setTimeout(() => {
      // Filter amenities by category
      const filtered = amenities.filter(a => categoryFilters[a.category]);

      console.log('Updating amenities layer with', filtered.length, 'filtered amenities');

      // Update map source
      const geojson: GeoJSON.FeatureCollection = {
        type: 'FeatureCollection',
        features: filtered.map(a => ({
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [a.longitude, a.latitude] },
          properties: {
            id: a.id,
            name: a.name,
            category: a.category,
            icon: a.icon,
            isHeavyRail: a.isHeavyRail || false,
            distance: a.distance,
            walkingTime: a.walkingTime,
          }
        }))
      };

      console.log('Setting amenities GeoJSON:', geojson);

      const amenitiesSource = map.current?.getSource('amenities') as mapboxgl.GeoJSONSource;
      if (amenitiesSource) {
        amenitiesSource.setData(geojson);
        console.log('Amenities data set successfully');
      } else {
        console.error('Amenities source not found!');
      }
    }, 100); // 100ms debounce

    return () => clearTimeout(timeoutId);
  }, [amenities, categoryFilters]);

  // Control layer visibility when amenities mode changes
  useEffect(() => {
    if (!map.current) return;

    console.log('Amenities mode:', showAmenities);

    if (showAmenities) {
      // Filter properties-points to only show the selected property
      const currentProperty = selectedProperty || selectedListing || selectedRental;
      console.log('Amenities mode activated, currentProperty:', currentProperty);
      console.log('selectedProperty:', selectedProperty);
      console.log('selectedListing:', selectedListing);
      console.log('selectedRental:', selectedRental);

      if (currentProperty && currentProperty.longitude && currentProperty.latitude) {
        console.log('Focusing on selected property for amenities mode:', currentProperty.address, 'coords:', currentProperty.longitude, currentProperty.latitude);

        // Hide clusters completely
        if (map.current.getLayer('clusters')) {
          console.log('Hiding clusters layer');
          map.current.setLayoutProperty('clusters', 'visibility', 'none');
        }

        // Hide properties-points completely and create star marker instead
        if (map.current.getLayer('properties-points')) {
          console.log('Hiding properties-points layer completely');
          map.current.setLayoutProperty('properties-points', 'visibility', 'none');
        }

        // Create star marker for selected property using Mapbox Maki icon
        if (!map.current.getLayer('selected-property-star')) {
          console.log('Creating star marker for selected property');

          // Ensure the properties source exists before adding the layer
          if (!map.current.getSource('properties')) {
            console.log('Properties source not found, creating it for star marker');
            // Create geojson from current properties data (only include properties with valid coordinates)
            const propertiesGeojson: GeoJSON.FeatureCollection = {
              type: 'FeatureCollection',
              features: properties
                .filter(p => p.longitude !== null && p.latitude !== null)
                .map(p => ({
                  type: 'Feature',
                  geometry: {
                    type: 'Point',
                    coordinates: [p.longitude!, p.latitude!]
                  },
                  properties: {
                    address: p.address,
                    soldPrice: p.soldPrice,
                    pricePerSqm: p.pricePerSqm,
                    beds: p.beds,
                    baths: p.baths,
                    areaSqm: p.areaSqm,
                    propertyType: p.propertyType,
                    soldDate: p.soldDate,
                    sourceUrl: p.sourceUrl,
                  }
                }))
            };

            map.current.addSource('properties', {
              type: 'geojson',
              data: propertiesGeojson,
            });
          }

          map.current.addLayer({
            id: 'selected-property-star',
            type: 'symbol',
            source: 'properties',
            filter: ['==', ['get', 'address'], currentProperty.address],
            layout: {
              'icon-image': 'star', // Mapbox Maki star icon
              'icon-size': [
                'interpolate',
                ['linear'],
                ['zoom'],
                9, 1.5,  // Larger star for prominence
                14, 2.0,
              ],
              'icon-allow-overlap': true,
              'icon-ignore-placement': true,
              'icon-anchor': 'center',
            },
            paint: {
              'icon-color': '#9333EA', // Purple/magenta for selected property
            }
          });
        }

        // Zoom to focus on the selected property (less zoomed in for better amenities view)
        map.current.flyTo({
          center: [currentProperty.longitude, currentProperty.latitude],
          zoom: 14,
          duration: 1000
        });
      } else {
        console.log('Cannot focus on property - missing coordinates or no current property');
        if (currentProperty) {
          console.log('Property exists but missing coords:', currentProperty.address, 'longitude:', currentProperty.longitude, 'latitude:', currentProperty.latitude);
        }
      }

      // Show amenities layers (they will become visible when data is loaded)
      const layersToShow = ['amenities-regular', 'amenities-heavy-rail'];
      layersToShow.forEach(layerId => {
        if (map.current?.getLayer(layerId)) {
          console.log('Showing layer:', layerId);
          map.current.setLayoutProperty(layerId, 'visibility', 'visible');
        } else {
          console.log('Amenities layer not found:', layerId);
        }
      });
    } else {
      // Hide amenities and restore map to normal view mode state
      console.log('Hiding amenities - restoring normal map view');

      // Restore map layers based on current view mode
      if (viewMode === 'clusters') {
        // Restore clusters if they should be visible
        if (map.current.getLayer('clusters')) {
          console.log('Restoring clusters layer');
          map.current.setLayoutProperty('clusters', 'visibility', 'visible');
        }
      } else if (viewMode === 'price') {
        // Restore properties-points layer
        if (map.current.getLayer('properties-points')) {
          console.log('Restoring properties-points layer');
          map.current.setLayoutProperty('properties-points', 'visibility', 'visible');
          // Remove the filter that was showing only selected property
          map.current.setFilter('properties-points', null);
        }
      }

      // Remove star marker layer
      if (map.current.getLayer('selected-property-star')) {
        console.log('Removing star marker layer');
        map.current.removeLayer('selected-property-star');
      }

      // Hide amenities layers
      const layersToHide = ['amenities-regular', 'amenities-heavy-rail'];
      layersToHide.forEach(layerId => {
        if (map.current?.getLayer(layerId)) {
          console.log('Hiding amenities layer:', layerId);
          map.current.setLayoutProperty(layerId, 'visibility', 'none');
        }
      });

      // Clear route if visible
      if (map.current.getSource('route')) {
        (map.current.getSource('route') as mapboxgl.GeoJSONSource)?.setData({
          type: 'FeatureCollection',
          features: []
        });
      }
      setRouteInfo(null);
    }
  }, [showAmenities, selectedProperty, selectedListing, selectedRental, viewMode]);

  // Zoom to amenities when they are loaded (but not when in amenities mode - let property focus handle zoom)
  useEffect(() => {
    const currentProperty = selectedProperty || selectedListing || selectedRental;
    if (!map.current || !currentProperty || showAmenities || amenities.length === 0) {
      console.log('Zoom effect skipped:', { map: !!map.current, property: !!currentProperty, showAmenities, amenitiesCount: amenities.length });
      return;
    }

    console.log('Zooming to amenities:', amenities.length, 'amenities');

    // Zoom to fit property and amenities
    const allCoords: [number, number][] = [];

    // Add property coordinates if available
    if (currentProperty.longitude !== null && currentProperty.latitude !== null) {
      allCoords.push([currentProperty.longitude, currentProperty.latitude]);
      console.log('Property coords:', currentProperty.longitude, currentProperty.latitude);
    }

    // Add amenity coordinates
    amenities.forEach(a => {
      allCoords.push([a.longitude, a.latitude]);
    });

    console.log('Total coords for zoom:', allCoords.length);

    if (allCoords.length > 0) {
      const bounds = allCoords.reduce((bounds, coord) => {
        return bounds.extend(coord);
      }, new mapboxgl.LngLatBounds(allCoords[0], allCoords[0]));

      console.log('Zooming to bounds');
      map.current.fitBounds(bounds, {
        padding: 100,
        maxZoom: 16, // Don't zoom in too much
        duration: 1000 // Smooth zoom animation
      });

      // Trigger resize after zoom to ensure proper layout
      setTimeout(() => {
        map.current?.resize();
      }, 1100);
    }
  }, [amenities, showAmenities, selectedProperty, selectedListing, selectedRental]);

  // Fetch amenities when any property type is selected and amenities are toggled on
  useEffect(() => {
    const abortController = new AbortController();

    const fetchAndDisplayAmenities = async (property: any) => {
      if (!property?.latitude || !property?.longitude) return;

      const cacheKey = `${property.latitude},${property.longitude}`;

      // Check cache first
      if (amenitiesCache.has(cacheKey)) {
        const cached = amenitiesCache.get(cacheKey)!;
        setAmenities(cached);
        setWalkabilityScore(calculateWalkabilityScore(cached));
        setAmenitiesError(null);
        return;
      }

      setLoadingAmenities(true);
      setAmenitiesError(null);

      try {
        // Validate coordinates
        if (!property.latitude || !property.longitude) {
          throw new Error('Invalid property coordinates');
        }

        console.log('Selected property coords:', property.latitude, property.longitude);

        const results = await fetchAmenities(
          property.latitude,
          property.longitude,
          1000, // 1km radius (2km total diameter) for nearby amenities only
          abortController.signal // Pass abort signal
        );

        // Check if request was cancelled
        if (abortController.signal.aborted) return;

        // If no amenities found from API, add test data for UI testing
        let finalResults = results;
        if (results.length === 0) {
          console.log('API returned no amenities, adding test data for UI testing');
          const testData = [
          {
            id: 'test-bus-stop',
            type: 'bus_stop' as any,
            category: 'public_transport' as any,
            name: 'ðŸš TEST BUS STOP (Click me!)',
            latitude: property.latitude + 0.01,
            longitude: property.longitude + 0.01,
            distance: 1000,
            walkingTime: 2,
            icon: 'bus',
            isHeavyRail: false,
            tags: { amenity: 'bus_stop', name: 'ðŸš TEST BUS STOP (Click me!)' } as Record<string, string>
          },
          {
            id: 'test-shop',
            type: 'supermarket' as any,
            category: 'shopping' as any,
            name: 'ðŸ›’ TEST SUPERMARKET (Click me!)',
            latitude: property.latitude - 0.01,
            longitude: property.longitude - 0.01,
            distance: 1100,
            walkingTime: 3,
            icon: 'grocery',
            isHeavyRail: false,
            tags: { shop: 'supermarket', name: 'ðŸ›’ TEST SUPERMARKET (Click me!)' } as Record<string, string>
          },
          {
            id: 'test-school',
            type: 'school' as any,
            category: 'education' as any,
            name: 'ðŸ« TEST SCHOOL (Click me!)',
            latitude: property.latitude + 0.007,
            longitude: property.longitude - 0.007,
            distance: 800,
            walkingTime: 16,
            icon: 'school',
            isHeavyRail: false,
            tags: { amenity: 'school', name: 'ðŸ« TEST SCHOOL (Click me!)' } as Record<string, string>
          },
          {
            id: 'test-dart',
            type: 'train_station' as any,
            category: 'public_transport' as any,
            name: 'ðŸš† TEST DART STATION (Heavy Rail!)',
            latitude: property.latitude - 0.007,
            longitude: property.longitude + 0.007,
            distance: 900,
            walkingTime: 18,
            icon: 'rail',
            isHeavyRail: true,
            tags: { railway: 'station', name: 'ðŸš† TEST DART STATION (Heavy Rail!)', operator: 'IarnrÃ³d Ã‰ireann' } as Record<string, string>
          }
          ];

          finalResults = testData;
        }

        // Calculate walkability score
        const score = calculateWalkabilityScore(finalResults);

        // Cache results
        setAmenitiesCache(prev => new Map(prev).set(cacheKey, results));
        setAmenities(results);
        setWalkabilityScore(score);

        // Track successful amenities loading
        const propertyType = selectedProperty ? 'sold' : selectedListing ? 'forSale' : 'rental';
        analytics.amenitiesLoaded(finalResults.length, propertyType);

        console.log('Amenities loaded:', finalResults.length, 'items');

      } catch (error) {
        if (error instanceof Error && error.name === 'AbortError') return; // Request was cancelled

        console.error('Failed to fetch amenities:', error);

        // Provide user-friendly error messages
        let errorMessage = 'Unable to load nearby amenities.';
        if (error instanceof Error) {
          if (error.message.includes('timeout')) {
            errorMessage = 'Request timed out. Please try again.';
          } else if (error.message.includes('network') || error.message.includes('fetch')) {
            errorMessage = 'Network error. Check your connection and try again.';
          } else if (error.message.includes('Rate limited')) {
            errorMessage = 'Service temporarily busy. Please wait a moment and try again.';
          }
        }

        setAmenitiesError(errorMessage);
      } finally {
        if (!abortController.signal.aborted) {
          setLoadingAmenities(false);
        }
      }
    };

    // Determine which property type is currently selected
    const currentProperty = selectedProperty || selectedListing || selectedRental;

    if (showAmenities && currentProperty) {
      fetchAndDisplayAmenities(currentProperty);
    } else {
      setAmenities([]);
      setWalkabilityScore(null);
      setAmenitiesError(null);
    }

    // Cleanup: cancel any ongoing requests
    return () => {
      abortController.abort();
    };
  }, [showAmenities, selectedProperty, selectedListing, selectedRental]);

  // Clear amenities when switching to a different property
  const prevPropertyRef = useRef<string | null>(null);

  useEffect(() => {
    const currentProperty = selectedProperty || selectedListing || selectedRental;
    const currentKey = currentProperty ? `${currentProperty.latitude},${currentProperty.longitude}` : null;

    // If property changed, reset amenities state
    if (currentKey !== prevPropertyRef.current) {
      console.log('Property changed, resetting amenities state');
      setAmenities([]);
      setWalkabilityScore(null);
      setShowAmenities(false);
      setLoadingAmenities(false); // Clear any loading state
      setAmenitiesError(null);
    }

    prevPropertyRef.current = currentKey;
  }, [selectedProperty, selectedListing, selectedRental]);

  // Hide amenities when property card is closed
  useEffect(() => {
    const hasSelectedProperty = selectedProperty || selectedListing || selectedRental;
    if (!hasSelectedProperty && showAmenities) {
      console.log('Property card closed, resetting amenities state');
      setShowAmenities(false);
      setAmenities([]);
      setWalkabilityScore(null);
      setAmenitiesError(null);
    }
  }, [selectedProperty, selectedListing, selectedRental, showAmenities]);

  // Route visualization function
  const fetchAndDisplayRoute = async (amenity: Amenity) => {
    // Get the currently selected property (any type)
    const currentProperty = selectedProperty || selectedListing || selectedRental;

    console.log('ðŸ›£ï¸ Getting route from:', currentProperty, 'to amenity:', amenity.name);

    if (!currentProperty?.latitude || !currentProperty?.longitude || !map.current) {
      console.log('âŒ Route failed: No current property or map not ready');
      return;
    }

    const origin: [number, number] = [currentProperty.longitude, currentProperty.latitude];
    const destination: [number, number] = [amenity.longitude, amenity.latitude];

    console.log('ðŸ“ Route request:', { origin, destination, travelMode });

    try {
      const response = await fetch(
        `https://api.mapbox.com/directions/v5/mapbox/${travelMode}/${origin.join(',')};${destination.join(',')}?` +
        `geometries=geojson&access_token=${MAPBOX_TOKEN}`
      );

      if (!response.ok) {
        throw new Error(`Directions API error: ${response.status}`);
      }

      const data = await response.json();

      if (data.routes && data.routes[0]) {
        const route = data.routes[0];

        console.log('âœ… Route found:', {
          distance: route.distance,
          duration: route.duration,
          coordinates: route.geometry.coordinates.length
        });

        setRouteInfo({
          distance: route.distance,
          duration: route.duration,
          geometry: route.geometry,
          mode: travelMode,
        });

        // Update route layer
        const routeSource = map.current.getSource('route') as mapboxgl.GeoJSONSource;
        if (routeSource) {
          // Create proper GeoJSON feature
          const routeFeature = {
            type: 'Feature' as const,
            geometry: route.geometry,
            properties: {
              distance: route.distance,
              duration: route.duration
            }
          };

          routeSource.setData(routeFeature);
          console.log('ðŸ—ºï¸ Route layer updated with', route.geometry.coordinates.length, 'coordinates');
        } else {
          console.log('âŒ Route source not found - creating it now');

          // Fallback: Try to create the route layer if it doesn't exist
          if (!map.current.getSource('route')) {
            map.current.addSource('route', {
              type: 'geojson',
              data: {
                type: 'Feature',
                geometry: route.geometry,
                properties: {}
              }
            });

            map.current.addLayer({
              id: 'route-line',
              type: 'line',
              source: 'route',
              paint: {
                'line-color': '#3B82F6',
                'line-width': 8,
                'line-opacity': 1.0,
              }
            }, 'amenities-regular');
          }
        }

        // Fit map to show full route
        try {
          const coordinates = route.geometry.coordinates;
          if (coordinates && coordinates.length > 0) {
            const bounds = new mapboxgl.LngLatBounds()
              .extend(coordinates[0] as [number, number])
              .extend(coordinates[coordinates.length - 1] as [number, number]);

            // Extend bounds to include some padding
            for (const coord of coordinates) {
              bounds.extend(coord as [number, number]);
            }

            map.current.fitBounds(bounds, {
              padding: 50,
              maxZoom: 18
            });
          }
        } catch (boundsError) {
          console.log('Bounds calculation failed, centering on destination');
          // Fallback: just center on the amenity
          map.current.flyTo({
            center: [amenity.longitude, amenity.latitude],
            zoom: 16
          });
        }

        // Clear any existing popups
        const popups = document.getElementsByClassName('mapboxgl-popup');
        Array.from(popups).forEach(popup => popup.remove());
      } else {
        console.log('âŒ No routes returned from API - trying fallback');

        // Fallback: Create a simple straight line route
        const fallbackRoute = {
          type: 'LineString' as const,
          coordinates: [
            [currentProperty.longitude, currentProperty.latitude],
            [amenity.longitude, amenity.latitude]
          ]
        };

        setRouteInfo({
          distance: Math.round(calculateDistance(currentProperty.latitude, currentProperty.longitude, amenity.latitude, amenity.longitude)),
          duration: Math.round(calculateDistance(currentProperty.latitude, currentProperty.longitude, amenity.latitude, amenity.longitude) * 12), // Rough walking time estimate
          geometry: fallbackRoute,
          mode: travelMode // Use current travel mode instead of 'fallback'
        });

        // Update route layer with fallback
        const routeSource = map.current.getSource('route') as mapboxgl.GeoJSONSource;
        if (routeSource) {
          routeSource.setData({
            type: 'Feature' as const,
            geometry: fallbackRoute,
            properties: {}
          });
        }

        // Center on the amenity
        map.current.flyTo({
          center: [amenity.longitude, amenity.latitude],
          zoom: 16
        });

        console.log('âœ… Fallback route created');
        return; // Don't throw error for fallback
      }
    } catch (error) {
      console.error('Failed to fetch route:', error);

      // Provide user-friendly error messages
      let errorMessage = 'Unable to get directions. Try Google Maps link above.';
      if (error instanceof Error) {
        if (error.message.includes('Rate limited') || error.message.includes('429')) {
          errorMessage = 'Too many requests. Please wait a moment and try again.';
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
          errorMessage = 'Network error. Check your connection and try again.';
        }
      }

      // Show error popup
      if (map.current) {
        new mapboxgl.Popup()
          .setLngLat([amenity.longitude, amenity.latitude])
          .setHTML(`<div style="color: #ef4444; padding: 8px;">${errorMessage}</div>`)
          .addTo(map.current);
      }
    }
  };

  // Set up global function for popup buttons
  useEffect(() => {
    (window as any).getDirections = (amenityId: string) => {
      console.log('ðŸŽ¯ getDirections called with amenityId:', amenityId);
      const amenity = amenities.find(a => a.id === amenityId);
      console.log('ðŸ“ Found amenity:', amenity);
      if (amenity) {
        fetchAndDisplayRoute(amenity);
      } else {
        console.log('âŒ Amenity not found in current amenities list');
      }
    };
  }, [amenities]);

  // Clear route when travel mode changes
  useEffect(() => {
    if (routeInfo && map.current) {
      (map.current.getSource('route') as mapboxgl.GeoJSONSource)?.setData({
        type: 'FeatureCollection',
        features: []
      });
      setRouteInfo(null);
    }
  }, [travelMode]);

  // Resize map when filter panel is toggled
  useEffect(() => {
    if (map.current) {
      // Small delay to allow DOM to update
      setTimeout(() => {
        map.current?.resize();
      }, 250);
    }
  }, [showFilters]);

  // Resize map on window resize and initial load
  useEffect(() => {
    const handleResize = () => {
      if (map.current) {
        map.current.resize();
      }
    };

    // Resize on mount
    setTimeout(handleResize, 100);

    // Resize on window resize
    window.addEventListener('resize', handleResize);

    return () => {
      window.removeEventListener('resize', handleResize);
    };
  }, [mapReady]);

  // Format sold date for display
  const formatSoldDate = (dateStr: string | undefined): string => {
    if (!dateStr) return 'Unknown';
    try {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-IE', { 
        year: 'numeric', 
        month: 'short',
        day: 'numeric'
      });
    } catch {
      return dateStr;
    }
  };

  // Get month and year from date (e.g., "Mar 2022")
  const getSoldMonthYear = (dateStr: string | undefined): string => {
    if (!dateStr) return 'Unknown';
    try {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-IE', { 
        year: 'numeric', 
        month: 'short'
      });
    } catch {
      return 'Unknown';
    }
  };

  // Property types for filter dropdown
  const propertyTypes = ['House', 'Apartment', 'Duplex', 'Terrace', 'Semi-D', 'Detached', 'Bungalow'];

  return (
    <div className="h-[calc(100vh-64px)] flex flex-col">
      {/* Main Control Bar - Single Row */}
      <div className="px-2 py-2 md:px-4 md:py-3 bg-[#111827] border-b border-gray-800 flex flex-wrap md:flex-nowrap items-center justify-between gap-2 md:gap-4">
        <div className="flex items-center gap-2 md:gap-4 flex-wrap md:flex-nowrap">
          {/* Data Source Multi-Select */}
          <div className="flex items-center gap-1 bg-gray-800 rounded-lg p-1 border border-gray-700">
            <button
              onClick={() => toggleDataSource('sold')}
              className={`flex-1 px-2 md:px-3 py-1.5 text-xs md:text-sm font-medium rounded-md transition-all ${
                dataSources.sold 
                  ? 'bg-cyan-600 text-white shadow-sm' 
                  : 'text-gray-400 hover:text-white hover:bg-gray-700'
              }`}
              title="Toggle sold properties"
            >
              Sold
            </button>
            <button
              onClick={() => toggleDataSource('forSale')}
              className={`flex-1 px-2 md:px-3 py-1.5 text-xs md:text-sm font-medium rounded-md transition-all ${
                dataSources.forSale
                  ? 'bg-rose-500 text-white shadow-sm'
                  : 'text-gray-400 hover:text-white hover:bg-gray-700'
              }`}
              title="Toggle for sale listings"
            >
              Sale
            </button>
            <button
              onClick={() => toggleDataSource('rentals')}
              className={`flex-1 px-2 md:px-3 py-1.5 text-xs md:text-sm font-medium rounded-md transition-all ${
                dataSources.rentals
                  ? 'bg-purple-500 text-white shadow-sm'
                  : 'text-gray-400 hover:text-white hover:bg-gray-700'
              }`}
              title="Toggle rental listings"
            >
              Rentals
            </button>
            {user?.tier === 'premium' && (
              <button
                onClick={() => toggleDataSource('savedOnly')}
                className={`flex-1 px-2 md:px-3 py-1.5 text-xs md:text-sm font-medium rounded-md transition-all ${
                  dataSources.savedOnly
                    ? 'bg-emerald-500 text-white shadow-sm'
                    : 'text-gray-400 hover:text-white hover:bg-gray-700'
                }`}
                title="Show only saved properties"
              >
                Saved
              </button>
            )}
          </div>

          {/* Progressive Loading Info */}
          <div className="text-xs text-gray-400 hidden md:block ml-2">
            <span className="flex items-center gap-1">
              <span className="w-2 h-2 bg-green-500 rounded-full"></span>
              Progressive loading active
            </span>
          </div>
          
          {/* Count display - shows totals for all selected sources */}
          <span className="hidden sm:inline text-gray-400 text-sm font-medium">
            {loading ? 'Loading...' : (
              <>
                {dataSources.savedOnly ? (
                  `${activeData.length.toLocaleString()} saved ${activeData.length === 1 ? 'property' : 'properties'}`
                ) : (
                  <>
                    {activeData.length.toLocaleString()} total
                    {activeSourceCount > 1 && (
                      <span className="text-gray-500 ml-1">
                        ({[
                          dataSources.sold && `${filteredProperties.length.toLocaleString()} sold`,
                          dataSources.forSale && `${filteredListings.length.toLocaleString()} sale`,
                          dataSources.rentals && `${filteredRentals.length.toLocaleString()} rentals`
                        ].filter(Boolean).join(' Â· ')})
                      </span>
                    )}
                  </>
                )}
              </>
            )}
          </span>
          
          {/* Location Search */}
          <div className="relative w-full sm:w-auto">
            <div className="flex items-center">
              <span className="absolute left-3 text-gray-500">ðŸ”</span>
              <input
                type="text"
                placeholder="Search location..."
                value={searchQuery}
                onChange={(e) => handleSearchChange(e.target.value)}
                onFocus={() => setShowSearchResults(true)}
                className="w-full sm:w-40 md:w-56 pl-9 pr-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-cyan-500 text-sm"
              />
              {isSearching && (
                <div className="absolute right-3 top-1/2 -translate-y-1/2">
                  <div className="w-4 h-4 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
              )}
            </div>
            
            {/* Search Results Dropdown */}
            {showSearchResults && (searchResults.length > 0 || searchQuery === '') && (
              <div className="absolute top-full left-0 right-0 mt-1 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 max-h-80 overflow-y-auto">
                {searchQuery === '' && (
                  <div className="p-2 border-b border-gray-700">
                    <div className="text-xs text-gray-500 mb-2 px-2">Quick jump to:</div>
                    <div className="flex flex-wrap gap-1">
                      {DUBLIN_AREAS.slice(0, 8).map((area) => (
                        <button
                          key={area.name}
                          onClick={() => flyToLocation(area.coords as [number, number], area.zoom)}
                          className="px-2 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded transition-colors"
                        >
                          {area.name}
                        </button>
                      ))}
                    </div>
                  </div>
                )}
                {searchResults.map((result, index) => (
                  <button
                    key={index}
                    onClick={() => {
                      flyToLocation(result.center, 15);
                      setSearchedLocation({ name: result.place_name, coords: result.center });
                      setShowSearchResults(false);
                      setSearchQuery(result.place_name);
                    }}
                    className="w-full px-4 py-3 text-left hover:bg-gray-700 text-white text-sm border-b border-gray-700 last:border-b-0 transition-colors"
                  >
                    <div className="flex items-center gap-2">
                      <span className="text-cyan-400">ðŸ“</span>
                      <span>{result.place_name}</span>
                    </div>
                  </button>
                ))}
                {searchQuery && searchResults.length === 0 && !isSearching && (
                  <div className="px-4 py-3 text-gray-500 text-sm">No results found</div>
                )}
              </div>
            )}
          </div>
        </div>
        
        <div className="flex items-center gap-1.5 md:gap-3">
          {/* View Mode Toggle */}
          <div className="flex rounded-lg overflow-hidden border border-gray-700">
            <button
              onClick={() => handleViewModeChange('clusters')}
              className={`flex-1 px-2 md:px-3 py-1.5 text-xs md:text-sm font-medium transition-colors whitespace-nowrap ${
                viewMode === 'clusters' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
              }`}
              title="Group nearby properties into clusters"
            >
              Clusters
            </button>
            <button
              onClick={() => handleViewModeChange('price')}
              className={`flex-1 px-2 md:px-3 py-1.5 text-xs md:text-sm font-medium transition-colors whitespace-nowrap ${
                viewMode === 'price' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
              }`}
              title="Color by price"
            >
              Price
            </button>
            {dataSources.sold && (
              <button
                onClick={() => handleViewModeChange('difference')}
                className={`flex-1 px-2 md:px-3 py-1.5 text-xs md:text-sm font-medium transition-colors whitespace-nowrap ${
                  viewMode === 'difference' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                }`}
                title="Color by sold vs asking price difference"
              >
                Over Asking
              </button>
            )}
          </div>
          
          
          {/* Filter Toggle Button */}
          <button
            onClick={() => setShowFilters(!showFilters)}
            className={`px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-all flex items-center gap-1.5 md:gap-2 ${
              showFilters || activeFilterCount > 0
                ? 'bg-indigo-600 text-white'
                : 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-700'
            }`}
          >
            <span>Filters</span>
            {activeFilterCount > 0 && (
              <span className="px-1.5 py-0.5 text-xs bg-white/20 rounded-full">
                {activeFilterCount}
              </span>
            )}
          </button>
        </div>
      </div>

      {/* Collapsible Filter Panel */}
      {showFilters && (
        <div className="bg-[#0d1117] border-b border-gray-800 px-2 py-2 md:px-3 md:py-3 animate-in slide-in-from-top duration-200">
          <div className="flex justify-end items-center mb-2 gap-2">
            {activeFilterCount > 0 && (
              <button
                onClick={handleClearFilters}
                className="px-4 py-2 md:px-3 md:py-1.5 text-sm font-medium text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 rounded transition-colors"
              >
                Clear All
              </button>
            )}
          </div>
          {/* BASIC FILTERS - Always Visible */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-3 md:gap-4">
            {/* VIEW MODE */}
            <div>
              <label className="text-xs text-gray-500 uppercase tracking-wider font-medium mb-2 block">View</label>
              <div className="flex flex-col gap-1">
                <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-white">
                  <input type="radio" checked={viewMode === 'clusters'} onChange={() => handleViewModeChange('clusters')} className="accent-indigo-500" />
                  Clusters
                </label>
                <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-white">
                  <input type="radio" checked={viewMode === 'price'} onChange={() => handleViewModeChange('price')} className="accent-indigo-500" />
                  By Price
                </label>
                {dataSources.sold && (
                  <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-white">
                    <input type="radio" checked={viewMode === 'difference'} onChange={() => handleViewModeChange('difference')} className="accent-indigo-500" />
                    Over Asking
                  </label>
                )}
              </div>
            </div>

            {/* TIME PERIOD */}
            <div>
              <div className="flex items-center gap-2 mb-2">
                <label className="text-xs text-gray-500 uppercase tracking-wider font-medium">Time Period</label>
                <div className="group relative">
                  <span className="text-xs text-gray-400 hover:text-gray-300 cursor-help border border-gray-400 rounded-full w-4 h-4 flex items-center justify-center">i</span>
                  <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10 border border-gray-600">
                    Time indicates when we captured the data, not when the listing was posted
                    <div className="absolute top-full left-1/2 transform -translate-x-1/2 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-600"></div>
                  </div>
                </div>
              </div>
              <div className="space-y-2">
                <div className="flex gap-1.5">
                  <select
                    value={selectedYear ?? ''}
                    onChange={(e) => {
                      const value = e.target.value;
                      if (value === 'all') {
                        setSelectedYear(null);
                        setSelectedQuarter(null);
                        setSelectedMonth(null);
                        setRecentFilter(null);
                        setTimeFilter(null);
                      } else {
                        setSelectedYear(parseInt(value));
                        setSelectedQuarter(null);
                        setSelectedMonth(null);
                        setRecentFilter(null);
                      }
                    }}
                    className="flex-1 px-2 py-1.5 text-sm bg-gray-800 border border-gray-700 rounded text-gray-300 focus:border-indigo-500 focus:outline-none"
                  >
                    <option value="all">All Time</option>
                    {availableYears.map(y => <option key={y} value={y.toString()}>{y}</option>)}
                  </select>
                  {selectedYear !== null && (
                    <select
                      value={selectedQuarter ?? ''}
                      onChange={(e) => { setSelectedQuarter(e.target.value ? parseInt(e.target.value) : null); setSelectedMonth(null); }}
                      className="flex-1 px-2 py-1.5 text-sm bg-gray-800 border border-gray-700 rounded text-gray-300 focus:border-indigo-500 focus:outline-none"
                    >
                      <option value="">Quarter</option>
                      <option value="1">Q1</option>
                      <option value="2">Q2</option>
                      <option value="3">Q3</option>
                      <option value="4">Q4</option>
                    </select>
                  )}
                </div>
                <div className="flex flex-col gap-0.5">
                  <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-white">
                    <input type="radio" name="timePeriod" checked={timeFilter === 'thisWeek'} onChange={() => { setSelectedYear(null); setSelectedQuarter(null); setSelectedMonth(null); setRecentFilter(null); setTimeFilter('thisWeek'); }} className="accent-indigo-500" />
                    This Week
                  </label>
                  <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-white">
                    <input type="radio" name="timePeriod" checked={timeFilter === 'thisMonth'} onChange={() => { setSelectedYear(null); setSelectedQuarter(null); setSelectedMonth(null); setRecentFilter(null); setTimeFilter('thisMonth'); }} className="accent-indigo-500" />
                    This Month
                  </label>
                  <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-white">
                    <input type="radio" name="timePeriod" checked={recentFilter === '6m'} onChange={() => { setSelectedYear(null); setSelectedQuarter(null); setSelectedMonth(null); setRecentFilter('6m'); setTimeFilter(null); }} className="accent-indigo-500" />
                    Last 6 Months
                  </label>
                </div>
              </div>
            </div>

            {/* PROPERTY BASICS */}
            <div>
              <label className="text-xs text-gray-500 uppercase tracking-wider font-medium mb-2 block">Property</label>
              <div className="space-y-2">
                <div>
                  <label className="text-xs text-gray-400 mb-1 block">Bedrooms</label>
                  <select
                    value={bedsFilter ?? ''}
                    onChange={(e) => setBedsFilter(e.target.value ? parseInt(e.target.value) : null)}
                    className="w-full px-2 py-1.5 text-sm bg-gray-800 border border-gray-700 rounded text-gray-300 focus:border-indigo-500 focus:outline-none"
                  >
                    <option value="">Any Beds</option>
                    <option value="1">1 Bed</option>
                    <option value="2">2 Beds</option>
                    <option value="3">3 Beds</option>
                    <option value="4">4 Beds</option>
                    <option value="5">5+ Beds</option>
                  </select>
                </div>

                <div>
                  <label className="text-xs text-gray-400 mb-1 block">Property Type</label>
                  <select
                    value={propertyTypeFilter ?? ''}
                    onChange={(e) => setPropertyTypeFilter(e.target.value || null)}
                    className="w-full px-2 py-1.5 text-sm bg-gray-800 border border-gray-700 rounded text-gray-300 focus:border-indigo-500 focus:outline-none"
                  >
                    <option value="">Any Type</option>
                    {propertyTypes.map(t => <option key={t} value={t}>{t}</option>)}
                  </select>
                </div>
              </div>
            </div>


            {/* PRICE */}
            <div>
              <label className="text-xs text-gray-500 uppercase tracking-wider font-medium mb-2 block">
                {dataSources.rentals ? 'Monthly Rent' : 'Price'}
              </label>
              <div className="flex gap-1.5">
                <input
                  type="number"
                  placeholder="Min â‚¬"
                  value={minPrice ?? ''}
                  onChange={(e) => setMinPrice(e.target.value ? parseInt(e.target.value) : null)}
                  className="flex-1 px-2 py-1.5 text-sm bg-gray-800 border border-gray-700 rounded text-gray-300 focus:border-indigo-500 focus:outline-none placeholder-gray-600"
                />
                <input
                  type="number"
                  placeholder="Max â‚¬"
                  value={maxPrice ?? ''}
                  onChange={(e) => setMaxPrice(e.target.value ? parseInt(e.target.value) : null)}
                  className="flex-1 px-2 py-1.5 text-sm bg-gray-800 border border-gray-700 rounded text-gray-300 focus:border-indigo-500 focus:outline-none placeholder-gray-600"
                />
              </div>
            </div>

          </div>

          {/* ADVANCED FILTERS TOGGLE */}
          <div className="flex justify-center items-center gap-4 mt-4">
            <button
              onClick={() => {
                setSelectedPropertyTypes([]);
                setSelectedDistanceBands([]);
                setBedsFilter(null);
                setPropertyTypeFilter(null);
                setMinPrice(null);
                setMaxPrice(null);
              }}
              className="text-sm text-gray-400 hover:text-white transition-colors underline underline-offset-2"
            >
              Clear filters
            </button>

            <button
              onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
              className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-blue-400 hover:text-blue-300 hover:bg-blue-500/10 rounded-lg border border-blue-500/20 hover:border-blue-400/40 transition-all shadow-sm"
            >
              <svg
                className={`w-4 h-4 transition-transform ${showAdvancedFilters ? 'rotate-180' : ''}`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
              {showAdvancedFilters ? 'Hide Advanced Filters' : 'Show Advanced Filters'}
              <span className="text-xs text-gray-500 ml-1">
                ({['Property Types', 'Distance', 'Size & Investment'].length} sections)
              </span>
            </button>
          </div>

          {/* ADVANCED FILTERS - Expandable Section */}
          <div className="mt-6">
            {showAdvancedFilters && (
              <div className="bg-gray-800/30 border border-gray-700/50 rounded-lg p-4">
                <div className="mb-4 text-center">
                  <h3 className="text-sm font-medium text-gray-300 uppercase tracking-wider mb-1">
                    Advanced Filters
                  </h3>
                  <p className="text-xs text-gray-500">
                    Detailed property search options
                  </p>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {/* PROPERTY TYPES */}
                <div className="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                  <PropertyTypeFilter
                    selectedTypes={selectedPropertyTypes}
                    onTypeChange={setSelectedPropertyTypes}
                    showCounts={true}
                    smartPresets={true}
                  />
                </div>

                {/* DISTANCE FILTER */}
                <div className="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                  <DistanceFilter
                    selectedBands={selectedDistanceBands}
                    onBandChange={setSelectedDistanceBands}
                    showPriceTrends={true}
                  />
                </div>

                {/* SIZE & INVESTMENT */}
                <div className="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                  <h4 className="text-sm font-medium text-white mb-3">Size & Investment</h4>
                  <div className="space-y-3">
                    {/* Area Filter */}
                    <div>
                      <label className="text-xs text-gray-400 mb-1 block">Property Size (mÂ²)</label>
                      <div className="flex gap-1.5">
                        <input
                          type="number"
                          placeholder="Min"
                          value={minArea ?? ''}
                          onChange={(e) => setMinArea(e.target.value ? parseInt(e.target.value) : null)}
                          className="flex-1 px-2 py-1.5 text-sm bg-gray-700 border border-gray-600 rounded text-gray-300 focus:border-indigo-500 focus:outline-none placeholder-gray-600"
                        />
                        <input
                          type="number"
                          placeholder="Max"
                          value={maxArea ?? ''}
                          onChange={(e) => setMaxArea(e.target.value ? parseInt(e.target.value) : null)}
                          className="flex-1 px-2 py-1.5 text-sm bg-gray-700 border border-gray-600 rounded text-gray-300 focus:border-indigo-500 focus:outline-none placeholder-gray-600"
                        />
                      </div>
                    </div>

                    {/* Yield Filter - only for sold and forSale */}
                    {(dataSources.sold || dataSources.forSale) && (
                      <div>
                        <label className="text-xs text-gray-400 mb-1 block">
                          Min Est. Yield: {yieldFilter !== null ? `${yieldFilter}%` : 'Any'}
                        </label>
                        <input
                          type="range"
                          min="0"
                          max="15"
                          step="0.5"
                          value={yieldFilter ?? 0}
                          onChange={(e) => setYieldFilter(e.target.value === '0' ? null : parseFloat(e.target.value))}
                          className="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider"
                          style={{
                            background: `linear-gradient(to right, #6366f1 0%, #6366f1 ${(yieldFilter ?? 0) / 15 * 100}%, #374151 ${(yieldFilter ?? 0) / 15 * 100}%, #374151 100%)`
                          }}
                        />
                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                          <span>0%</span>
                          <span>15%</span>
                        </div>
                      </div>
                    )}

                    {/* Sale Type Difference - only for sold */}
                    {dataSources.sold && (
                      <div>
                        <label className="text-xs text-gray-400 mb-1 block">
                          Sale vs Asking: {differenceFilter !== null ? `${differenceFilter > 0 ? '+' : ''}${differenceFilter}%` : 'Any'}
                        </label>
                        <input
                          type="range"
                          min="-20"
                          max="50"
                          step="5"
                          value={differenceFilter ?? 0}
                          onChange={(e) => {
                            const newValue = e.target.value === '0' ? null : parseInt(e.target.value);
                            setDifferenceFilter(newValue);
                            if (newValue !== null) {
                              setDataSources(prev => ({ ...prev, sold: true, forSale: false, rentals: false }));
                            }
                          }}
                          className="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider"
                          style={{
                            background: differenceFilter !== null && differenceFilter !== 0
                              ? `linear-gradient(to right, #22c55e 0%, #22c55e ${Math.max(0, (differenceFilter + 20) / 70 * 100)}%, #6366f1 ${Math.max(0, (differenceFilter + 20) / 70 * 100)}%, #6366f1 100%)`
                              : undefined
                          }}
                        />
                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                          <span>-20%</span>
                          <span>+50%</span>
                        </div>
                        <div className="text-xs text-gray-400 mt-1">
                          {differenceFilter === null || differenceFilter === 0 ? 'All sales' :
                           differenceFilter > 0 ? `Bidding wars only` : `Deals only`}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
                </div>

              </div>
            )}
          </div>

        </div>
      )}

      {/* Compact Legend Bar */}
      <div className="hidden sm:flex px-4 py-1.5 bg-[#0D1117] border-b border-gray-800 items-center gap-4 text-xs text-gray-400 overflow-x-auto">
        {/* Cluster view - show cluster colors when zoomed out, property colors when zoomed in */}
        {viewMode === 'clusters' && zoomLevel < 14 && (
          <>
            <span className="text-gray-500 font-medium shrink-0">Clusters:</span>
            <div className="flex items-center gap-3">
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> &lt;10</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span> 10-50</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-400"></span> 50-100</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"></span> 200+</span>
            </div>
          </>
        )}
        {/* When zoomed in to individual properties in cluster mode */}
        {viewMode === 'clusters' && zoomLevel >= 14 && activeSourceCount === 1 && dataSources.sold && (
          <>
            <span className="text-gray-500 font-medium shrink-0">â‚¬/mÂ²:</span>
            <div className="flex items-center gap-3">
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span> â‚¬2k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> â‚¬4k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-400"></span> â‚¬6k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-orange-500"></span> â‚¬8k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"></span> â‚¬10k+</span>
            </div>
          </>
        )}
        {viewMode === 'clusters' && zoomLevel >= 14 && activeSourceCount === 1 && dataSources.forSale && (
          <>
            <span className="text-gray-500 font-medium shrink-0">For Sale:</span>
            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-rose-500"></span> All listings</span>
          </>
        )}
        {viewMode === 'clusters' && zoomLevel >= 14 && activeSourceCount === 1 && dataSources.rentals && (
          <>
            <span className="text-gray-500 font-medium shrink-0">Rentals:</span>
            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-purple-500"></span> All rentals</span>
          </>
        )}
        {viewMode === 'clusters' && zoomLevel >= 14 && activeSourceCount > 1 && (
          <>
            <span className="text-gray-500 font-medium shrink-0">Type:</span>
            <div className="flex items-center gap-3">
              {dataSources.sold && <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-white border border-gray-500"></span> Sold</span>}
              {dataSources.forSale && <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-rose-500"></span> For Sale</span>}
              {dataSources.rentals && <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-purple-500"></span> Rental</span>}
            </div>
          </>
        )}
        {viewMode === 'price' && (dataSources.sold || dataSources.forSale) && (
          <>
            <span className="text-gray-500 font-medium shrink-0">Price:</span>
            <div className="flex items-center gap-3">
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span> â‚¬200k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> â‚¬400k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-400"></span> â‚¬600k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-orange-500"></span> â‚¬800k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"></span> â‚¬1M+</span>
            </div>
          </>
        )}
        {viewMode === 'price' && dataSources.rentals && !dataSources.sold && !dataSources.forSale && (
          <>
            <span className="text-gray-500 font-medium shrink-0">Rent:</span>
            <div className="flex items-center gap-3">
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span> â‚¬1k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> â‚¬1.5k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-400"></span> â‚¬2k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-orange-500"></span> â‚¬2.5k</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"></span> â‚¬3k+</span>
            </div>
          </>
        )}
        {viewMode === 'difference' && dataSources.sold && (
          <>
            <span className="text-gray-500 font-medium shrink-0">Over Asking:</span>
            <div className="flex items-center gap-3">
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span> -20%</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-400"></span> At asking</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"></span> +20%</span>
            </div>
          </>
        )}
        {/* Show type legend when multiple sources selected and zoomed out */}
        {activeSourceCount > 1 && zoomLevel < 14 && (
          <>
            <span className="mx-2 text-gray-700">|</span>
            <span className="text-gray-500 font-medium shrink-0">Type:</span>
            <div className="flex items-center gap-3">
              {dataSources.sold && <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-white border border-gray-500"></span> Sold</span>}
              {dataSources.forSale && <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-rose-500"></span> For Sale</span>}
              {dataSources.rentals && <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-purple-500"></span> Rental</span>}
            </div>
          </>
        )}
      </div>
      
      {/* Map */}
      <div className="flex-1 relative">
        <div ref={mapContainer} className="absolute inset-0" style={{ width: '100%', height: '100%' }} />
        


        {/* Map error display */}
        {mapError && (
          <div className="absolute inset-4 z-10 bg-red-900/95 backdrop-blur-xl rounded-lg p-6 border border-red-500 shadow-xl">
            <div className="flex items-start gap-3">
              <div className="w-6 h-6 text-red-400 mt-0.5">
                <svg fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="flex-1">
                <h3 className="text-white font-semibold mb-2">Map Loading Error</h3>
                <p className="text-red-200 text-sm mb-4">{mapError}</p>
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setMapError(null);
                      window.location.reload();
                    }}
                    className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-md transition-colors"
                  >
                    Retry
                  </button>
                  <button
                    onClick={() => setMapError(null)}
                    className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-md transition-colors"
                  >
                    Dismiss
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Amenities Mode Indicator */}
        {showAmenities && (selectedProperty || selectedListing || selectedRental) && (
          <div className="absolute top-4 left-4 z-10 bg-blue-600/95 backdrop-blur-xl rounded-lg px-4 py-3 border border-blue-400 shadow-xl">
            <div className="flex items-center justify-between gap-4">
              <div className="flex items-center gap-3">
                <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                <div>
                  <div className="text-white text-sm font-medium">Exploring Nearby</div>
                  <div className="text-blue-200 text-xs">
                    {amenities.length > 0 ? `${amenities.filter(a => categoryFilters[a.category]).length} amenities visible` : 'Loading...'}
                  </div>
                </div>
              </div>
              <button
                onClick={() => setShowAmenities(false)}
                className="px-3 py-1 text-xs bg-blue-700 hover:bg-blue-800 text-white rounded-md transition-colors font-medium"
              >
                Exit
              </button>
            </div>
          </div>
        )}
        
        {/* Selected Property Panel */}
        {selectedProperty && (
          <div
            className={`absolute left-4 right-4 md:left-4 md:right-auto md:w-[400px] bg-gray-900/95 backdrop-blur-xl rounded-xl shadow-2xl border border-gray-700 z-50 transition-all duration-300 ${
              isMobile && isMobileAmenitiesMode
                ? 'top-4 h-16 p-3 flex items-center justify-between max-h-16 overflow-hidden'
                : 'bottom-4 md:bottom-4 p-4 md:p-5 max-h-[85vh] md:max-h-[85vh] overflow-y-auto'
            }`}
            onClick={(e) => e.stopPropagation()}
          >

            {/* Share Error Notification */}
            {soldShare.error && (
              <div className="absolute top-12 right-4 bg-red-900/95 text-red-200 text-xs px-3 py-2 rounded border border-red-700 z-10 max-w-xs">
                {soldShare.error}
              </div>
            )}

            {/* Header with Minimize, Share and Close buttons */}
            <div className={`absolute top-4 right-4 flex gap-1 z-10 ${isMobile && isMobileAmenitiesMode ? 'hidden' : ''}`}>
              <button
                onClick={() => {
                  soldShare.shareProperty();
                  analytics.propertyShared('sold');
                }}
                disabled={soldShare.isGenerating}
                className="px-2 py-1 text-xs bg-gray-800 hover:bg-gray-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-gray-300 hover:text-white rounded transition-colors border border-gray-700"
                title="Share this property"
              >
                {soldShare.isGenerating ? (
                  <>
                    <svg className="animate-spin h-3 w-3" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Sharing...
                  </>
                ) : (
                  <>
                    Share
                  </>
                )}
              </button>
              {user && user.tier === 'premium' && (
                <button
                  onClick={async () => {
                    const propertyId = selectedProperty.address; // Use address as unique ID
                    const alreadySaved = isSaved(propertyId, 'sold');

                    if (alreadySaved) {
                      const result = await unsaveProperty(propertyId, 'sold');
                      if (result.success) {
                        analytics.propertyUnsaved('sold');
                      }
                    } else {
                      const result = await saveProperty(
                        propertyId,
                        'sold',
                        selectedProperty,
                        undefined
                      );
                      if (result.success) {
                        analytics.propertySaved('sold');
                      }
                    }
                  }}
                  className={`px-2 py-1 text-xs rounded transition-colors border ${
                    isSaved(selectedProperty.address, 'sold')
                      ? 'bg-red-600 hover:bg-red-700 text-white border-red-500'
                      : 'bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white border-gray-700'
                  }`}
                  title={isSaved(selectedProperty.address, 'sold') ? 'Remove from saved properties' : 'Save this property'}
                >
                  {isSaved(selectedProperty.address, 'sold') ? 'Saved' : 'Save'}
                </button>
              )}
              {user && (
                <PropertyReportButton
                  propertyId={selectedProperty.address}
                  propertyType="sold"
                  address={selectedProperty.address}
                  latitude={selectedProperty.latitude}
                  longitude={selectedProperty.longitude}
                />
              )}
              <button
                onClick={() => setIsMobileAmenitiesMode(true)}
                className="px-2 py-1 text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white rounded transition-colors border border-gray-700"
                title="Minimize property card"
              >
                âˆ’
              </button>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  console.log('Close button clicked for property:', selectedProperty?.address);
                  isClosingRef.current = true;
                  setSelectedProperty(null);
                  setTimeout(() => {
                    isClosingRef.current = false;
                  }, 100);
                }}
                className="text-gray-500 hover:text-white text-xl p-1 rounded hover:bg-gray-700 transition-colors"
                title="Close property card"
              >
                âœ•
              </button>
            </div>

            {/* Mobile Amenities Mode - Minimized Bar */}
            {isMobile && isMobileAmenitiesMode ? (
              <>
                {/* Property info in minimized bar */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <h3 className="font-semibold text-white text-sm truncate flex-1">
                      {selectedProperty.address}
                    </h3>
                    <span className="text-gray-300 text-xs font-mono">
                      {formatFullPrice(selectedProperty.soldPrice)}
                    </span>
                  </div>
                  <div className="flex items-center gap-2 mt-1">
                    {selectedProperty.beds && (
                      <span className="text-gray-400 text-xs">{selectedProperty.beds} bed</span>
                    )}
                    {selectedProperty.baths && (
                      <span className="text-gray-400 text-xs">â€¢ {selectedProperty.baths} bath</span>
                    )}
                  </div>
                </div>

                {/* Controls */}
                <div className="flex items-center gap-2 ml-2">
                  <button
                    onClick={() => {
                      setShowAmenities(false);
                      setIsMobileAmenitiesMode(false);
                      analytics.amenitiesExited('sold');
                    }}
                    className="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
                  >
                    Exit
                  </button>
                  <button
                    onClick={() => setIsMobileAmenitiesMode(false)}
                    className="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white rounded-md transition-colors"
                  >
                    â†‘ Expand
                  </button>
                </div>
              </>
            ) : (
              <>
                {/* Mobile Tab Navigation */}
                <div className="flex gap-1 mb-2 px-2 pt-12">
                <button
                  onClick={() => setActiveTab('details')}
                  className={`flex-1 py-3 px-4 rounded-lg font-medium text-sm transition-colors ${
                    activeTab === 'details'
                      ? 'bg-blue-600 text-white shadow-lg'
                      : 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-600'
                  }`}
                  style={{ minHeight: '44px' }} // Ensure 44px touch target
                >
                  Details
                </button>
                <button
                  onClick={() => setActiveTab('planning')}
                  className={`flex-1 py-3 px-4 rounded-lg font-medium text-sm transition-colors ${
                    activeTab === 'planning'
                      ? 'bg-blue-600 text-white shadow-lg'
                      : 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-600'
                  }`}
                  style={{ minHeight: '44px' }} // Ensure 44px touch target
                >
                  Planning Permission
                </button>
                </div>

                {/* Header spacing to avoid overlap with header buttons */}
                <div className="h-2"></div>

                {/* Property Address - Always visible */}
                <h3 className="font-semibold text-white pr-32 mb-3 text-lg leading-tight">
                  {selectedProperty.address}
                </h3>

                {/* Tab Content */}
                {activeTab === 'details' ? (
                  <>

                    {/* Save Property Button - Inside Card */}
                    {user && user.tier === 'premium' && (
                      <div className="mb-4">
                        <button
                          onClick={async () => {
                            const propertyId = selectedProperty.address; // Use address as unique ID
                            const alreadySaved = isSaved(propertyId, 'sold');

                            if (alreadySaved) {
                              const result = await unsaveProperty(propertyId, 'sold');
                              if (result.success) {
                                analytics.propertyUnsaved('sold');
                              }
                            } else {
                              const result = await saveProperty(
                                propertyId,
                                'sold',
                                selectedProperty,
                                undefined
                              );
                              if (result.success) {
                                analytics.propertySaved('sold');
                              }
                            }
                          }}
                          className={`px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 border ${
                            isSaved(selectedProperty.address, 'sold')
                              ? 'bg-red-600 hover:bg-red-700 text-white border-red-500'
                              : 'bg-blue-600 hover:bg-blue-700 text-white border-blue-500'
                          }`}
                        >
                          {isSaved(selectedProperty.address, 'sold') ? (
                            <>
                              <span>â¤ï¸</span>
                              Saved
                            </>
                          ) : (
                            <>
                              <span>ðŸ’¾</span>
                              Save Property
                            </>
                          )}
                        </button>
                      </div>
                    )}

            {/* Walkability Score - Prominent Display */}
            {walkabilityScore && (
              <div className="mb-6">
                <WalkabilityScore
                  score={walkabilityScore.score}
                  rating={walkabilityScore.rating}
                  breakdown={walkabilityScore.breakdown}
                  className="mb-4"
                />

                {/* Nearest Transport Highlight */}
                {walkabilityScore.nearestDartLuas && walkabilityScore.nearestDartLuas.distance <= 500 && (
                  <div className="flex items-center gap-2 text-sm bg-green-900/20 border border-green-700/30 rounded-lg px-3 py-2 mb-4">
                    <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span className="text-green-300">{walkabilityScore.nearestDartLuas.type} station</span>
                    <span className="text-green-100 font-medium">{walkabilityScore.nearestDartLuas.distance}m away</span>
                  </div>
                )}

                {/* Detailed Breakdown */}
                {amenities.length > 0 && (
                  <WalkabilityBreakdown
                    amenities={amenities}
                    nearestAmenities={amenities
                      .filter(a => a.isHeavyRail)
                      .slice(0, 3)
                      .map(a => ({
                        name: a.name,
                        type: a.type,
                        distance: a.distance,
                        walkingTime: a.walkingTime
                      }))
                    }
                    className="mt-4"
                  />
                )}

                {/* Walkability Legend */}
                <WalkabilityLegend className="mt-4" />
              </div>
            )}

            {/* Distance from City Centre */}
            {selectedProperty.latitude && selectedProperty.longitude && (
              <DistanceDisplay
                latitude={selectedProperty.latitude}
                longitude={selectedProperty.longitude}
                className="mb-6"
              />
            )}

            {/* Price with year badge */}
            <div className="flex items-center gap-3 mb-4">
              <div className="text-3xl font-bold text-white font-mono">
                {formatFullPrice(selectedProperty.soldPrice)}
              </div>
              <div className="px-3 py-1 rounded-full bg-blue-600 text-white text-sm font-medium">
                Sold {getSoldMonthYear(selectedProperty.soldDate)}
              </div>
            </div>

            {/* Price analysis - moved up */}
            <div className="space-y-2 mb-4">
              {selectedProperty.askingPrice && selectedProperty.askingPrice > 0 && (
                <>
                  <div className="flex justify-between items-center">
                    <span className="text-gray-500 text-sm">Asking price</span>
                    <span className="text-gray-300 font-mono">{formatFullPrice(selectedProperty.askingPrice)}</span>
                  </div>

                  <div className="flex justify-between items-center">
                    <span className="text-gray-500 text-sm">Difference</span>
                    <span className={`font-semibold text-lg ${
                      selectedProperty.soldPrice > selectedProperty.askingPrice
                        ? 'text-red-400'
                        : selectedProperty.soldPrice < selectedProperty.askingPrice
                        ? 'text-green-400'
                        : 'text-gray-300'
                    }`}>
                      {selectedProperty.soldPrice > selectedProperty.askingPrice ? '+' : ''}
                      {formatFullPrice(Math.abs(selectedProperty.soldPrice - selectedProperty.askingPrice))}
                      {selectedProperty.askingPrice > 0 && (
                        <span className="text-sm ml-1">
                          ({selectedProperty.soldPrice > selectedProperty.askingPrice ? '+' : ''}
                          {Math.round(((selectedProperty.soldPrice - selectedProperty.askingPrice) / selectedProperty.askingPrice) * 100)}%)
                        </span>
                      )}
                    </span>
                  </div>

                  {selectedProperty.areaSqm && selectedProperty.areaSqm > 0 && (
                    <div className="flex justify-between items-center">
                      <span className="text-gray-500 text-sm">Price per mÂ²</span>
                      <span className="text-gray-300 font-mono">
                        â‚¬{Math.round(selectedProperty.soldPrice / selectedProperty.areaSqm).toLocaleString()}
                      </span>
                    </div>
                  )}

                </>
              )}
            </div>

            {/* Property details grid */}
            <div className="grid grid-cols-2 gap-2 mb-3">
              {selectedProperty.beds && (
                <div className="bg-gray-800 rounded-md px-2 py-1.5">
                  <div className="text-gray-500 text-xs">Bedrooms</div>
                  <div className="text-white font-semibold text-sm">{selectedProperty.beds}</div>
                </div>
              )}
              {selectedProperty.baths && (
                <div className="bg-gray-800 rounded-md px-2 py-1.5">
                  <div className="text-gray-500 text-xs">Bathrooms</div>
                  <div className="text-white font-semibold text-sm">{selectedProperty.baths}</div>
                </div>
              )}
              {selectedProperty.propertyType && (
                <div className="bg-gray-800 rounded-md px-2 py-1.5">
                  <div className="text-gray-500 text-xs">Type</div>
                  <div className="text-white font-semibold text-sm">{selectedProperty.propertyType}</div>
                </div>
              )}
              {selectedProperty.areaSqm && (
                <div className="bg-gray-800 rounded-md px-2 py-1.5">
                  <div className="text-gray-500 text-xs">Floor Area</div>
                  <div className="text-white font-semibold text-sm">{selectedProperty.areaSqm} mÂ²</div>
                </div>
              )}
            </div>

            {/* Mortgage Calculator Button */}
            <div className="mb-6">
              <button
                onClick={() => {
                  console.log('Mortgage button clicked for property:', selectedProperty);
                  console.log('Property address:', selectedProperty.address);

                  // Calculate mortgage parameters from property data
                  const homeValue = selectedProperty.soldPrice || selectedProperty.askingPrice || 0;

                  if (homeValue <= 0) {
                    alert('Unable to calculate mortgage: Property price not available');
                    return;
                  }

                  const downPayment = Math.max(homeValue * 0.1, 20000); // 10% down or â‚¬20k minimum
                  const loanAmount = Math.max(homeValue - downPayment, 0);

                  // Build URL with pre-filled parameters
                  const params = new URLSearchParams({
                    homeValue: homeValue.toString(),
                    downPayment: downPayment.toString(),
                    loanAmount: loanAmount.toString(),
                    interestRate: '3.5', // Default rate
                    loanTerm: '30', // Default term
                    propertyType: selectedProperty.propertyType || 'House',
                    address: encodeURIComponent(selectedProperty.address || ''),
                  });

                  const url = `/mortgage-calc?${params.toString()}`;
                  console.log('Navigating to mortgage calculator:', url);

                  // Navigate to mortgage calculator with pre-filled data
                  window.location.href = url;
                }}
                className="w-full px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-medium text-sm transition-all duration-200 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl border border-green-500 hover:border-green-400"
                title="Calculate mortgage for this property"
              >
                <span>ðŸ </span>
                Calculate Mortgage
              </button>
            </div>

            {/* Nearby Amenities Section */}
            <div className="mt-4 pt-4 border-t border-gray-700 mb-6">
              <div className="flex items-center justify-between mb-3">
                <h4 className="text-sm font-medium text-gray-300">Nearby Amenities</h4>
                {showAmenities && amenities.length > 0 && (
                  <span className="text-xs text-gray-500">
                    {amenities.filter(a => categoryFilters[a.category]).length} found
                  </span>
                )}
              </div>

              <button
                onClick={() => {
                  const newShowAmenities = !showAmenities;
                  setShowAmenities(newShowAmenities);

                  // Mobile: Enable/disable full-screen amenities mode
                  if (isMobile) {
                    setIsMobileAmenitiesMode(newShowAmenities);
                  }

                  if (newShowAmenities) {
                    // Track when amenities exploration starts - determine property type
                    const propertyType = selectedProperty ? 'sold' : selectedListing ? 'forSale' : 'rental';
                    analytics.amenitiesExplored(propertyType);
                  } else {
                    // Track when amenities mode is exited
                    const propertyType = selectedProperty ? 'sold' : selectedListing ? 'forSale' : 'rental';
                    analytics.amenitiesExited(propertyType);
                  }
                }}
                disabled={loadingAmenities}
                className={`w-full px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-3 ${
                  showAmenities
                    ? 'bg-blue-600 text-white shadow-lg'
                    : 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-600'
                }`}
              >
                {loadingAmenities ? (
                  <>
                    <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    <span>Loading nearby amenities...</span>
                  </>
                ) : showAmenities ? (
                  <>
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>Hide Amenities</span>
                  </>
                ) : (
                  <>
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Explore Nearby</span>
                  </>
                )}
              </button>

              {amenitiesError && (
                <p className="text-red-400 text-xs mt-2">{amenitiesError}</p>
              )}

              {/* Amenities Controls */}
              {showAmenities && amenities.length > 0 && (
                <div className="mt-4 space-y-4">
                  {/* Category Filters */}
                  <div>
                    <label className="text-xs text-gray-500 uppercase tracking-wider font-medium mb-2 block">Categories</label>
                    <div className="grid grid-cols-2 gap-2">
                      {Object.entries(categoryFilters).map(([category, enabled]) => {
                        const count = amenities.filter(a => a.category === category).length;
                        return (
                          <button
                            key={category}
                            onClick={() => setCategoryFilters(prev => ({ ...prev, [category]: !enabled }))}
                            className={`px-3 py-2 rounded-md text-sm font-medium transition-all flex items-center justify-between ${
                              enabled
                                ? 'bg-blue-600 text-white shadow-md'
                                : 'bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-600'
                            }`}
                          >
                            <span>{getCategoryDisplayName(category as any)}</span>
                            <span className={`text-xs px-2 py-0.5 rounded ${
                              enabled ? 'bg-white/20' : 'bg-gray-600'
                            }`}>
                              {count}
                            </span>
                          </button>
                        );
                      })}
                    </div>
                  </div>

                </div>
              )}
            </div>
            </>
                ) : (
                  // Planning Permission Tab
                  <div className="space-y-4">
                    <PlanningCard
                      key={`planning-mobile-${selectedProperty.address}`}
                      latitude={selectedProperty.latitude || 0}
                      longitude={selectedProperty.longitude || 0}
                      address={selectedProperty.address}
                      dublinPostcode={selectedProperty.dublinPostcode || undefined}
                      propertyType="sold"
                      forceLoad={true}
                    />
                  </div>
                )}
              </>
            )}

          </div>
        )}

        {/* Planning Property Highlight */}
        {(selectedProperty || selectedListing || selectedRental) && !isMobile && (
          <div className={`absolute left-4 z-30 ${
            showAmenities ? 'top-16' : 'top-4'
          }`}>
            <div className="bg-blue-600/90 backdrop-blur-xl rounded-lg px-3 py-2 border border-blue-400 shadow-lg">
              <div className="text-white text-sm font-medium">
                ðŸ—ï¸ Viewing Planning Data
              </div>
              <div className="text-blue-200 text-xs">
                {selectedProperty?.address || selectedListing?.address || selectedRental?.address}
              </div>
              <div className="text-blue-100 text-xs mt-1">
                ðŸ” 150m planning search area shown on map
              </div>
            </div>
          </div>
        )}


        {/* Selected Listing Panel (For Sale) */}
        {selectedListing && (
          <div
            className={`absolute left-4 right-4 md:left-4 md:right-auto md:w-[400px] bg-gray-900/95 backdrop-blur-xl rounded-xl shadow-2xl border border-cyan-700 z-50 transition-all duration-300 ${
              isMobile && isMobileAmenitiesMode
                ? 'bottom-4 h-16 p-3 flex items-center justify-between max-h-16 overflow-hidden'
                : 'bottom-4 md:bottom-4 p-4 md:p-5 max-h-[85vh] md:max-h-[85vh] overflow-y-auto'
            }`}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header with Minimize, Share and Close buttons */}
            <div className={`absolute top-4 right-4 flex gap-2 z-10 ${isMobile && isMobileAmenitiesMode ? 'hidden' : ''}`}>
              <button
                onClick={() => {
                  listingShare.shareProperty();
                  analytics.propertyShared('forSale');
                }}
                disabled={listingShare.isGenerating}
                className="px-2 py-1 text-xs bg-gray-800 hover:bg-gray-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-gray-300 hover:text-white rounded transition-colors flex items-center gap-1 border border-gray-700"
                title="Share this property"
              >
                {listingShare.isGenerating ? (
                  <>
                    <div className="w-3 h-3 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"></div>
                    <span>Generating...</span>
                  </>
                ) : (
                  <>
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </>
                )}
              </button>
              {user && (
                <>
                  <button
                    onClick={async () => {
                      const propertyId = selectedListing.address; // Use address as unique ID
                      const alreadySaved = isSaved(propertyId, 'listing');

                      if (alreadySaved) {
                        const result = await unsaveProperty(propertyId, 'listing');
                        if (result.success) {
                          analytics.propertyUnsaved('forSale');
                        }
                      } else {
                        const result = await saveProperty(
                          propertyId,
                          'listing',
                          selectedListing,
                          undefined
                        );
                        if (result.success) {
                          analytics.propertySaved('forSale');
                        }
                      }
                    }}
                    className={`px-2 py-1 text-xs rounded transition-colors flex items-center gap-1 border ${
                      isSaved(selectedListing.address, 'listing')
                        ? 'bg-red-600 hover:bg-red-700 text-white border-red-500'
                        : 'bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white border-gray-700'
                    }`}
                    title={isSaved(selectedListing.address, 'listing') ? 'Remove from saved properties' : 'Save this property'}
                  >
                    {isSaved(selectedListing.address, 'listing') ? 'Saved' : 'Save'}
                  </button>
                  <PropertyReportButton
                    propertyId={selectedListing.address}
                    propertyType="listing"
                    address={selectedListing.address}
                    latitude={selectedListing.latitude}
                    longitude={selectedListing.longitude}
                  />
                </>
              )}
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  console.log('Close button clicked for listing:', selectedListing?.address);
                  isClosingRef.current = true;
                  setSelectedListing(null);
                  setTimeout(() => {
                    isClosingRef.current = false;
                  }, 100);
                }}
                className="text-gray-500 hover:text-white text-xl p-1 rounded hover:bg-gray-700 transition-colors"
                title="Close property card"
              >
                âœ•
              </button>
            </div>

            {/* Share Error Notification */}
            {listingShare.error && (
              <div className="absolute top-12 right-4 bg-red-900/95 text-red-200 text-xs px-3 py-2 rounded border border-red-700 z-10 max-w-xs">
                {listingShare.error}
              </div>
            )}

            {/* Minimize Button - Always Available */}
            <div className="absolute top-4 right-4 z-10">
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      console.log('Close button clicked for property:', selectedProperty?.address);
                      isClosingRef.current = true;
                      setSelectedProperty(null);
                      setTimeout(() => {
                        isClosingRef.current = false;
                      }, 100);
                    }}
                    className="text-gray-500 hover:text-white text-xl p-1 rounded hover:bg-gray-700 transition-colors"
                    title="Close property card"
                  >
                    âœ•
                  </button>
                  <button
                    onClick={() => setIsMobileAmenitiesMode(true)}
                    className="px-2 py-1 text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white rounded transition-colors border border-gray-700"
                    title="Minimize property card"
                  >
                    âˆ’
                  </button>
            </div>

            {/* Mobile Amenities Mode - Minimized Bar */}
            {isMobile && isMobileAmenitiesMode ? (
              <>
                {/* Property info in minimized bar */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <h3 className="font-semibold text-white text-sm truncate flex-1">
                      {selectedListing.address}
                    </h3>
                    <span className="text-cyan-300 text-xs font-mono">
                      {formatFullPrice(selectedListing.askingPrice)}
                    </span>
                  </div>
                  <div className="flex items-center gap-2 mt-1">
                    {selectedListing.beds && (
                      <span className="text-gray-400 text-xs">{selectedListing.beds} bed</span>
                    )}
                    {selectedListing.baths && (
                      <span className="text-gray-400 text-xs">â€¢ {selectedListing.baths} bath</span>
                    )}
                  </div>
                </div>

                {/* Controls */}
                <div className="flex items-center gap-2 ml-2">
                  <button
                    onClick={() => {
                      setShowAmenities(false);
                      setIsMobileAmenitiesMode(false);
                      analytics.amenitiesExited('forSale');
                    }}
                    className="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
                  >
                    Exit
                  </button>
                  <button
                    onClick={() => setIsMobileAmenitiesMode(false)}
                    className="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white rounded-md transition-colors"
                  >
                    â†‘ Expand
                  </button>
                </div>
              </>
            ) : (
              <>
                {/* Mobile Tab Navigation */}
                <div className="flex gap-1 mb-2 px-2 pt-12">
                <button
                  onClick={() => setActiveTab('details')}
                  className={`flex-1 py-3 px-4 rounded-lg font-medium text-sm transition-colors ${
                    activeTab === 'details'
                      ? 'bg-blue-600 text-white shadow-lg'
                      : 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-600'
                  }`}
                  style={{ minHeight: '44px' }} // Ensure 44px touch target
                >
                  Details
                </button>
                <button
                  onClick={() => setActiveTab('planning')}
                  className={`flex-1 py-3 px-4 rounded-lg font-medium text-sm transition-colors ${
                    activeTab === 'planning'
                      ? 'bg-blue-600 text-white shadow-lg'
                      : 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-600'
                  }`}
                  style={{ minHeight: '44px' }} // Ensure 44px touch target
                >
                  Planning Permission
                </button>
                </div>

                {/* Header spacing to avoid overlap with header buttons */}
                <div className="h-2"></div>

                {/* Property Address - Always visible */}
                <h3 className="font-semibold text-white pr-32 mb-3 text-lg leading-tight">
                  {selectedListing.address}
                </h3>

                {/* Tab Content */}
                {activeTab === 'details' ? (
                  <>

            {/* Property Insights */}
            {walkabilityScore && (
              <div className="mb-4 space-y-2">
                <div className="flex items-center justify-between">
                  <span className="text-sm font-medium text-gray-300">Walkability Score</span>
                  <div className="flex items-center gap-2">
                    <div className="w-16 h-2 bg-gray-700 rounded-full overflow-hidden">
                      <div
                        className="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-300"
                        style={{ width: `${walkabilityScore.score * 10}%` }}
                      ></div>
                    </div>
                    <span className="text-sm font-semibold text-white min-w-[2rem]">{walkabilityScore.score}/10</span>
                  </div>
                </div>

                <div className="text-xs text-gray-400 capitalize">{walkabilityScore.rating}</div>

                {walkabilityScore.nearestDartLuas && walkabilityScore.nearestDartLuas.distance <= 500 && (
                  <div className="flex items-center gap-2 text-sm">
                    <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span className="text-gray-300">{walkabilityScore.nearestDartLuas.type} station</span>
                    <span className="text-white font-medium">{walkabilityScore.nearestDartLuas.distance}m away</span>
                  </div>
                )}
              </div>
            )}

            {/* Nearby Amenities Section */}
            <div className="mt-4 pt-4 border-t border-gray-700 mb-6">
              <div className="flex items-center justify-between mb-3">
                <h4 className="text-sm font-medium text-gray-300">Nearby Amenities</h4>
                {showAmenities && amenities.length > 0 && (
                  <span className="text-xs text-gray-500">
                    {amenities.filter(a => categoryFilters[a.category]).length} found
                  </span>
                )}
              </div>

              <button
                onClick={() => {
                  const newShowAmenities = !showAmenities;
                  setShowAmenities(newShowAmenities);

                  // Mobile: Enable/disable full-screen amenities mode
                  if (isMobile) {
                    setIsMobileAmenitiesMode(newShowAmenities);
                  }

                  if (newShowAmenities) {
                    // Track when amenities exploration starts - determine property type
                    const propertyType = selectedProperty ? 'sold' : selectedListing ? 'forSale' : 'rental';
                    analytics.amenitiesExplored(propertyType);
                  } else {
                    // Track when amenities mode is exited
                    const propertyType = selectedProperty ? 'sold' : selectedListing ? 'forSale' : 'rental';
                    analytics.amenitiesExited(propertyType);
                  }
                }}
                disabled={loadingAmenities}
                className={`w-full px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-3 ${
                  showAmenities
                    ? 'bg-blue-600 text-white shadow-lg'
                    : 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-600'
                }`}
              >
                {loadingAmenities ? (
                  <>
                    <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    <span>Loading nearby amenities...</span>
                  </>
                ) : showAmenities ? (
                  <>
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>Hide Amenities</span>
                  </>
                ) : (
                  <>
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Explore Nearby</span>
                  </>
                )}
              </button>

              {amenitiesError && (
                <p className="text-red-400 text-xs mt-2">{amenitiesError}</p>
              )}

              {/* Amenities Controls */}
              {showAmenities && amenities.length > 0 && (
                <div className="mt-4 space-y-4">
                  {/* Category Filters */}
                  <div>
                    <label className="text-xs text-gray-500 uppercase tracking-wider font-medium mb-2 block">Categories</label>
                    <div className="grid grid-cols-2 gap-2">
                      {Object.entries(categoryFilters).map(([category, enabled]) => {
                        const count = amenities.filter(a => a.category === category).length;
                        return (
                          <button
                            key={category}
                            onClick={() => setCategoryFilters(prev => ({ ...prev, [category]: !enabled }))}
                            className={`px-3 py-2 rounded-md text-sm font-medium transition-all flex items-center justify-between ${
                              enabled
                                ? 'bg-blue-600 text-white shadow-md'
                                : 'bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-600'
                            }`}
                          >
                            <span>{getCategoryDisplayName(category as any)}</span>
                            <span className={`text-xs px-2 py-0.5 rounded ${
                              enabled ? 'bg-white/20' : 'bg-gray-600'
                            }`}>
                              {count}
                            </span>
                          </button>
                        );
                      })}
                    </div>
                  </div>

                </div>
              )}
            </div>

            {/* Price with For Sale badge */}
            <div className="flex items-center gap-3 mb-4">
              <div className="text-3xl font-bold text-white font-mono">
                {formatFullPrice(selectedListing.askingPrice)}
              </div>
              <div className="px-3 py-1 rounded-full bg-cyan-600 text-white text-sm font-medium flex items-center gap-1">
                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 7V3a2 2 0 012-2z" />
                </svg>
                For Sale
              </div>
            </div>
            
            {/* Property details grid */}
            <div className="grid grid-cols-2 gap-2 mb-3">
              {selectedListing.beds && (
                <div className="bg-gray-800 rounded-md px-2 py-1.5">
                  <div className="text-gray-500 text-xs">Bedrooms</div>
                  <div className="text-white font-semibold text-sm">{selectedListing.beds}</div>
                </div>
              )}
              {selectedListing.baths && (
                <div className="bg-gray-800 rounded-md px-2 py-1.5">
                  <div className="text-gray-500 text-xs">Bathrooms</div>
                  <div className="text-white font-semibold text-sm">{selectedListing.baths}</div>
                </div>
              )}
              {selectedListing.propertyType && (
                <div className="bg-gray-800 rounded-md px-2 py-1.5">
                  <div className="text-gray-500 text-xs">Type</div>
                  <div className="text-white font-semibold text-sm">{selectedListing.propertyType}</div>
                </div>
              )}
              {selectedListing.berRating && (
                <div className="bg-gray-800 rounded-md px-2 py-1.5">
                  <div className="text-gray-500 text-xs">BER Rating</div>
                  <div className="text-white font-semibold text-sm">{selectedListing.berRating}</div>
                </div>
              )}
            </div>

            {/* Mortgage Calculator Button for Listings */}
            <div className="mb-4">
              <button
                onClick={() => {
                  const homeValue = selectedListing.askingPrice || 0;

                  if (homeValue <= 0) {
                    alert('Unable to calculate mortgage: Property price not available');
                    return;
                  }

                  const downPayment = Math.max(homeValue * 0.1, 20000);
                  const loanAmount = Math.max(homeValue - downPayment, 0);

                  const params = new URLSearchParams({
                    homeValue: homeValue.toString(),
                    downPayment: downPayment.toString(),
                    loanAmount: loanAmount.toString(),
                    interestRate: '3.5',
                    loanTerm: '30',
                    propertyType: selectedListing.propertyType || 'House',
                    address: encodeURIComponent(selectedListing.address || ''),
                  });

                  window.location.href = `/mortgage-calc?${params.toString()}`;
                }}
                className="w-full px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-medium text-sm transition-all duration-200 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl border border-green-500 hover:border-green-400"
                title="Calculate mortgage for this property"
              >
                <span>ðŸ </span>
                Calculate Mortgage
              </button>
            </div>

            {/* Price per sqm */}
            {selectedListing.pricePerSqm && selectedListing.pricePerSqm > 0 && (
              <div className="border-t border-gray-700 pt-4">
                <div className="flex justify-between items-center">
                  <span className="text-gray-500 text-sm">Price per mÂ²</span>
                  <div className="flex items-center gap-2">
                    <span className="text-white font-mono">â‚¬{selectedListing.pricePerSqm.toLocaleString()}</span>
                    {listingStats.avgPricePerSqm > 0 && selectedListing.pricePerSqm < listingStats.avgPricePerSqm * 0.85 && (
                      <span className="px-2 py-0.5 rounded bg-green-600/20 text-green-400 text-xs font-medium">
                        Below avg
                      </span>
                    )}
                    {listingStats.avgPricePerSqm > 0 && selectedListing.pricePerSqm > listingStats.avgPricePerSqm * 1.2 && (
                      <span className="px-2 py-0.5 rounded bg-orange-600/20 text-orange-400 text-xs font-medium">
                        Above avg
                      </span>
                    )}
                  </div>
                </div>
              </div>
            )}
            
            {/* Yield Estimate */}
            {selectedListing.yieldEstimate && (
              <div className="border-t border-gray-700 pt-4 mt-4">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-gray-500 text-sm">Est. Gross Yield</span>
                  <div className="flex items-center gap-2">
                    <span className="text-emerald-400 font-bold font-mono">
                      {selectedListing.yieldEstimate.grossYield.toFixed(1)}%
                    </span>
                    <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                      selectedListing.yieldEstimate.confidence === 'high' ? 'bg-green-600/20 text-green-400' :
                      selectedListing.yieldEstimate.confidence === 'medium' ? 'bg-yellow-600/20 text-yellow-400' :
                      'bg-orange-600/20 text-orange-400'
                    }`} title="Confidence level based on available rental data">
                      {selectedListing.yieldEstimate.confidence === 'very_low' ? 'âš ï¸ limited data' : `${selectedListing.yieldEstimate.confidence} confidence`}
                    </span>
                  </div>
                </div>
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-500">Est. Monthly Rent</span>
                  <span className="text-white font-mono">â‚¬{selectedListing.yieldEstimate.monthlyRent.toLocaleString()}/mo</span>
                </div>
                <div className="flex justify-between items-center text-sm mt-1">
                  <span className="text-gray-500">Est. Annual Return</span>
                  <span className="text-white font-mono">â‚¬{(selectedListing.yieldEstimate.monthlyRent * 12).toLocaleString()}/yr</span>
                </div>
                <p className="text-xs text-gray-500 mt-2">
                  {selectedListing.yieldEstimate.note}
                  <span className="text-gray-600"> â€¢ Based on asking price â‚¬{selectedListing.askingPrice.toLocaleString()}</span>
                </p>
              </div>
            )}
            </>
                ) : (
                  // Planning Permission Tab
                  <div className="space-y-4">
                    <PlanningCard
                      key={`planning-mobile-${selectedListing.address}`}
                      latitude={selectedListing.latitude || 0}
                      longitude={selectedListing.longitude || 0}
                      address={selectedListing.address}
                      dublinPostcode={selectedListing.dublinPostcode || undefined}
                      propertyType="forSale"
                      forceLoad={true}
                    />
                  </div>
                )}
              </>
            )}

          </div>
        )}

        {/* Selected Rental Panel */}
        {selectedRental && (
          <>
            {/* Backdrop */}
            <div
              className="fixed inset-0 bg-black/50 z-40"
              onClick={() => setSelectedRental(null)}
            />
            {/* Modal */}
            <div
              className={`absolute left-4 right-4 md:left-4 md:right-auto md:w-[400px] bg-gray-900/95 backdrop-blur-xl rounded-xl shadow-2xl border border-purple-600 z-50 transition-all duration-300 ${
                isMobile && isMobileAmenitiesMode
                  ? 'bottom-4 h-16 p-3 flex items-center justify-between max-h-16 overflow-hidden'
                  : 'bottom-4 md:bottom-4 p-4 md:p-5 max-h-[85vh] md:max-h-[85vh] overflow-y-auto'
              }`}
              onClick={(e) => e.stopPropagation()}
            >
            {/* Header with Minimize, Share and Close buttons */}
            <div className={`absolute top-4 right-4 flex gap-2 z-10 ${isMobile && isMobileAmenitiesMode ? 'hidden' : ''}`}>
              <button
                onClick={() => {
                  rentalShare.shareProperty();
                  analytics.propertyShared('rental');
                }}
                disabled={rentalShare.isGenerating}
                className="px-2 py-1 text-xs bg-gray-800 hover:bg-gray-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-gray-300 hover:text-white rounded transition-colors flex items-center gap-1 border border-gray-700"
                title="Share this property"
              >
                {rentalShare.isGenerating ? (
                  <>
                    <div className="w-3 h-3 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"></div>
                    <span>Generating...</span>
                  </>
                ) : (
                  <>
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </>
                )}
              </button>
              {user && (
                <>
                  <button
                    onClick={async () => {
                      const propertyId = selectedRental.address; // Use address as unique ID
                      const alreadySaved = isSaved(propertyId, 'rental');

                      if (alreadySaved) {
                        const result = await unsaveProperty(propertyId, 'rental');
                        if (result.success) {
                          analytics.propertyUnsaved('rental');
                        }
                      } else {
                        const result = await saveProperty(
                          propertyId,
                          'rental',
                          selectedRental,
                          undefined
                        );
                        if (result.success) {
                          analytics.propertySaved('rental');
                        }
                      }
                    }}
                    className={`px-2 py-1 text-xs rounded transition-colors flex items-center gap-1 border ${
                      isSaved(selectedRental.address, 'rental')
                        ? 'bg-red-600 hover:bg-red-700 text-white border-red-500'
                        : 'bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white border-gray-700'
                    }`}
                    title={isSaved(selectedRental.address, 'rental') ? 'Remove from saved properties' : 'Save this property'}
                  >
                    {isSaved(selectedRental.address, 'rental') ? 'Saved' : 'Save'}
                  </button>
                  <PropertyReportButton
                    propertyId={selectedRental.address}
                    propertyType="rental"
                    address={selectedRental.address}
                    latitude={selectedRental.latitude}
                    longitude={selectedRental.longitude}
                  />
                </>
              )}
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  console.log('Close button clicked for rental:', selectedRental?.address);
                  isClosingRef.current = true;
                  setSelectedRental(null);
                  setTimeout(() => {
                    isClosingRef.current = false;
                  }, 100);
                }}
                className="text-gray-400 hover:text-white text-xl p-2 rounded hover:bg-gray-700 transition-colors border border-transparent hover:border-gray-600"
                title="Close rental property card"
              >
                âœ•
              </button>
            </div>

            {/* Share Error Notification */}
            {rentalShare.error && (
              <div className="absolute top-12 right-4 bg-red-900/95 text-red-200 text-xs px-3 py-2 rounded border border-red-700 z-10 max-w-xs">
                {rentalShare.error}
              </div>
            )}

            {/* Minimize Button - Always Available */}
            <div className="absolute top-4 right-4 z-10">
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      console.log('Close button clicked for property:', selectedProperty?.address);
                      isClosingRef.current = true;
                      setSelectedProperty(null);
                      setTimeout(() => {
                        isClosingRef.current = false;
                      }, 100);
                    }}
                    className="text-gray-500 hover:text-white text-xl p-1 rounded hover:bg-gray-700 transition-colors"
                    title="Close property card"
                  >
                    âœ•
                  </button>
                  <button
                    onClick={() => setIsMobileAmenitiesMode(true)}
                    className="px-2 py-1 text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white rounded transition-colors border border-gray-700"
                    title="Minimize property card"
                  >
                    âˆ’
                  </button>
            </div>

            {/* Mobile Amenities Mode - Minimized Bar */}
            {isMobile && isMobileAmenitiesMode ? (
              <>
                {/* Property info in minimized bar */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <h3 className="font-semibold text-white text-sm truncate flex-1">
                      {selectedRental.address}
                    </h3>
                    <span className="text-purple-300 text-xs font-mono">
                      â‚¬{selectedRental.monthlyRent.toLocaleString()}/mo
                    </span>
                  </div>
                  <div className="flex items-center gap-2 mt-1">
                    {selectedRental.beds && (
                      <span className="text-gray-400 text-xs">{selectedRental.beds} bed</span>
                    )}
                    {selectedRental.baths && (
                      <span className="text-gray-400 text-xs">â€¢ {selectedRental.baths} bath</span>
                    )}
                  </div>
                </div>

                {/* Controls */}
                <div className="flex items-center gap-2 ml-2">
                  <button
                    onClick={() => {
                      setShowAmenities(false);
                      setIsMobileAmenitiesMode(false);
                      analytics.amenitiesExited('rental');
                    }}
                    className="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
                  >
                    Exit
                  </button>
                  <button
                    onClick={() => setIsMobileAmenitiesMode(false)}
                    className="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white rounded-md transition-colors"
                  >
                    â†‘ Expand
                  </button>
                </div>
              </>
            ) : (
              <>
                {/* Mobile Tab Navigation */}
                <div className="flex gap-1 mb-2 px-2 pt-12">
                <button
                  onClick={() => setActiveTab('details')}
                  className={`flex-1 py-3 px-4 rounded-lg font-medium text-sm transition-colors ${
                    activeTab === 'details'
                      ? 'bg-blue-600 text-white shadow-lg'
                      : 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-600'
                  }`}
                  style={{ minHeight: '44px' }} // Ensure 44px touch target
                >
                  Details
                </button>
                <button
                  onClick={() => setActiveTab('planning')}
                  className={`flex-1 py-3 px-4 rounded-lg font-medium text-sm transition-colors ${
                    activeTab === 'planning'
                      ? 'bg-blue-600 text-white shadow-lg'
                      : 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-600'
                  }`}
                  style={{ minHeight: '44px' }} // Ensure 44px touch target
                >
                  Planning Permission
                </button>
                </div>

                {/* Header spacing to avoid overlap with header buttons */}
                <div className="h-2"></div>

                {/* Property Address - Always visible */}
                <h3 className="font-semibold text-white pr-32 mb-3 text-lg leading-tight">
                  {selectedRental.address}
                </h3>

                {/* Tab Content */}
                {activeTab === 'details' ? (
                  <>

                  {/* Property Insights */}
                  {walkabilityScore && (
                    <div className="mb-4 space-y-2">
                      <div className="flex items-center justify-between">
                        <span className="text-sm font-medium text-gray-300">Walkability Score</span>
                        <div className="flex items-center gap-2">
                          <div className="w-16 h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div
                              className="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-300"
                              style={{ width: `${walkabilityScore.score * 10}%` }}
                            ></div>
                          </div>
                          <span className="text-sm font-semibold text-white min-w-[2rem]">{walkabilityScore.score}/10</span>
                        </div>
                      </div>
      
                      <div className="text-xs text-gray-400 capitalize">{walkabilityScore.rating}</div>
      
                      {walkabilityScore.nearestDartLuas && walkabilityScore.nearestDartLuas.distance <= 500 && (
                        <div className="flex items-center gap-2 text-sm">
                          <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                          <span className="text-gray-300">{walkabilityScore.nearestDartLuas.type} station</span>
                          <span className="text-white font-medium">{walkabilityScore.nearestDartLuas.distance}m away</span>
                        </div>
                      )}
                    </div>
                  )}
      
                  {/* Nearby Amenities Section */}
                  <div className="mt-4 pt-4 border-t border-gray-700 mb-6">
                    <div className="flex items-center justify-between mb-3">
                      <h4 className="text-sm font-medium text-gray-300">Nearby Amenities</h4>
                      {showAmenities && amenities.length > 0 && (
                        <span className="text-xs text-gray-500">
                          {amenities.filter(a => categoryFilters[a.category]).length} found
                        </span>
                      )}
                    </div>
      
                    <button
                      onClick={() => {
                        const newShowAmenities = !showAmenities;
                        setShowAmenities(newShowAmenities);
      
                        // Mobile: Enable/disable full-screen amenities mode
                        if (isMobile) {
                          setIsMobileAmenitiesMode(newShowAmenities);
                        }
      
                        if (newShowAmenities) {
                          // Track when amenities exploration starts - determine property type
                          const propertyType = selectedProperty ? 'sold' : selectedListing ? 'forSale' : 'rental';
                          analytics.amenitiesExplored(propertyType);
                        } else {
                          // Track when amenities mode is exited
                          const propertyType = selectedProperty ? 'sold' : selectedListing ? 'forSale' : 'rental';
                          analytics.amenitiesExited(propertyType);
                        }
                      }}
                      disabled={loadingAmenities}
                      className={`w-full px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-3 ${
                        showAmenities
                          ? 'bg-blue-600 text-white shadow-lg'
                          : 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-600'
                      }`}
                    >
                      {loadingAmenities ? (
                        <>
                          <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                          <span>Loading nearby amenities...</span>
                        </>
                      ) : showAmenities ? (
                        <>
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                          <span>Hide Amenities</span>
                        </>
                      ) : (
                        <>
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                          </svg>
                          <span>Explore Nearby</span>
                        </>
                      )}
                    </button>
      
                    {amenitiesError && (
                      <p className="text-red-400 text-xs mt-2">{amenitiesError}</p>
                    )}
      
                    {/* Amenities Controls */}
                    {showAmenities && amenities.length > 0 && (
                      <div className="mt-4 space-y-4">
                        {/* Category Filters */}
                        <div>
                          <label className="text-xs text-gray-500 uppercase tracking-wider font-medium mb-2 block">Categories</label>
                          <div className="grid grid-cols-2 gap-2">
                            {Object.entries(categoryFilters).map(([category, enabled]) => {
                              const count = amenities.filter(a => a.category === category).length;
                              return (
                                <button
                                  key={category}
                                  onClick={() => setCategoryFilters(prev => ({ ...prev, [category]: !enabled }))}
                                  className={`px-3 py-2 rounded-md text-sm font-medium transition-all flex items-center justify-between ${
                                    enabled
                                      ? 'bg-blue-600 text-white shadow-md'
                                      : 'bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-600'
                                  }`}
                                >
                                  <span>{getCategoryDisplayName(category as any)}</span>
                                  <span className={`text-xs px-2 py-0.5 rounded ${
                                    enabled ? 'bg-white/20' : 'bg-gray-600'
                                  }`}>
                                    {count}
                                  </span>
                                </button>
                              );
                            })}
                          </div>
                        </div>
      
                      </div>
                    )}
                  </div>
      
                  {/* Rent with badge */}
                  <div className="flex items-center gap-3 mb-4">
                    <div className="text-3xl font-bold text-white font-mono">
                      â‚¬{selectedRental.monthlyRent.toLocaleString()}/mo
                    </div>
                    <div className="px-3 py-1 rounded-full bg-purple-500 text-white text-sm font-medium flex items-center gap-1">
                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                      </svg>
                      Rental
                    </div>
                  </div>
                  
                  {/* Property details grid */}
                  <div className="grid grid-cols-3 gap-2 mb-3">
                    {selectedRental.beds && (
                      <div className="bg-gray-800 rounded-md px-2 py-1.5">
                        <div className="text-gray-500 text-xs">Bedrooms</div>
                        <div className="text-white font-semibold text-sm">{selectedRental.beds}</div>
                      </div>
                    )}
                    {selectedRental.baths && (
                      <div className="bg-gray-800 rounded-md px-2 py-1.5">
                        <div className="text-gray-500 text-xs">Bathrooms</div>
                        <div className="text-white font-semibold text-sm">{selectedRental.baths}</div>
                      </div>
                    )}
                    {selectedRental.propertyType && (
                      <div className="bg-gray-800 rounded-md px-2 py-1.5">
                        <div className="text-gray-500 text-xs">Type</div>
                        <div className="text-white font-semibold text-sm">{selectedRental.propertyType}</div>
                      </div>
                    )}
                    {selectedRental.berRating && (
                      <div className="bg-gray-800 rounded-md px-2 py-1.5">
                        <div className="text-gray-500 text-xs">BER</div>
                        <div className="text-white font-semibold text-sm">{selectedRental.berRating}</div>
                      </div>
                    )}
                    {selectedRental.furnishing && (
                      <div className="bg-gray-800 rounded-md px-2 py-1.5">
                        <div className="text-gray-500 text-xs">Furnished</div>
                        <div className="text-white font-semibold text-sm">{selectedRental.furnishing}</div>
                      </div>
                    )}
                    {selectedRental.dublinPostcode && (
                      <div className="bg-gray-800 rounded-md px-2 py-1.5">
                        <div className="text-gray-500 text-xs">Area</div>
                        <div className="text-white font-semibold text-sm">{selectedRental.dublinPostcode}</div>
                      </div>
                    )}
                  </div>
      
                  {/* Mortgage Calculator Button for Rentals */}
                  <div className="mb-4">
                    <button
                      onClick={() => {
                        // For rentals, estimate home value based on annual rent
                        const monthlyRent = selectedRental.monthlyRent || 0;
                        const homeValue = monthlyRent * 240; // Estimate based on 20-year equivalent
      
                        if (homeValue <= 0) {
                          alert('Unable to calculate mortgage: Rental price not available');
                          return;
                        }
      
                        const downPayment = Math.max(homeValue * 0.1, 20000);
                        const loanAmount = Math.max(homeValue - downPayment, 0);
      
                        const params = new URLSearchParams({
                          homeValue: homeValue.toString(),
                          downPayment: downPayment.toString(),
                          loanAmount: loanAmount.toString(),
                          interestRate: '3.5',
                          loanTerm: '30',
                          propertyType: selectedRental.propertyType || 'Apartment',
                          address: encodeURIComponent(selectedRental.address || ''),
                        });
      
                        window.location.href = `/mortgage-calc?${params.toString()}`;
                      }}
                      className="w-full px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-medium text-sm transition-all duration-200 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl border border-green-500 hover:border-green-400"
                      title="Calculate mortgage for this rental property"
                    >
                      <span>ðŸ </span>
                      Calculate Mortgage
                    </button>
                  </div>
      
                  {/* Rent per sqm/bed */}
                  <div className="border-t border-gray-700 pt-4 space-y-2">
                    {selectedRental.rentPerBed && (
                      <div className="flex justify-between items-center">
                        <span className="text-gray-500 text-sm">Rent per bedroom</span>
                        <span className="text-white font-mono">â‚¬{selectedRental.rentPerBed.toLocaleString()}/mo</span>
                      </div>
                    )}
                    {selectedRental.rentPerSqm && (
                      <div className="flex justify-between items-center">
                        <span className="text-gray-500 text-sm">Rent per mÂ²</span>
                        <span className="text-white font-mono">â‚¬{selectedRental.rentPerSqm.toFixed(2)}/mo</span>
                      </div>
                    )}
                  </div>
                  </>
                ) : (
                  // Planning Permission Tab
                  <div className="space-y-4">
                    <PlanningCard
                      key={`planning-mobile-${selectedRental.address}`}
                      latitude={selectedRental.latitude || 0}
                      longitude={selectedRental.longitude || 0}
                      address={selectedRental.address}
                      dublinPostcode={selectedRental.dublinPostcode || undefined}
                      propertyType="rental"
                      forceLoad={true}
                    />
                  </div>
                )}
              </>
            )}

          </div>
        )}
        </>




        {/* Stats overlay - hidden when property/listing/rental panel is open */}
        {!selectedProperty && !selectedListing && !selectedRental && (
          <div className="absolute top-4 left-4 hidden md:block">
            <div className="bg-gray-900/90 backdrop-blur-xl rounded-lg p-4 border border-gray-700 min-w-[180px]">
              {dataSources.sold && (
              <>
                <div className="text-sm text-gray-500 mb-1">
                  {filteredStats.isFiltered ? `${getTimeFilterLabel()} Avg â‚¬/mÂ²` : 'Dublin Avg â‚¬/mÂ²'}
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-2xl font-bold text-white font-mono">
                    â‚¬{(filteredStats.isFiltered ? filteredStats.avgPricePerSqm : stats.avgPricePerSqm).toLocaleString()}
                  </span>
                  {filteredStats.isFiltered && filteredStats.percentChange !== null && (
                    <span className={`text-sm font-semibold px-1.5 py-0.5 rounded ${
                      filteredStats.percentChange > 0 
                        ? 'bg-green-500/20 text-green-400' 
                        : filteredStats.percentChange < 0 
                          ? 'bg-red-500/20 text-red-400'
                          : 'bg-gray-500/20 text-gray-400'
                    }`}>
                      {filteredStats.percentChange > 0 ? 'â†‘' : filteredStats.percentChange < 0 ? 'â†“' : ''}
                      {Math.abs(filteredStats.percentChange).toFixed(1)}%
                    </span>
                  )}
                </div>
                {filteredStats.isFiltered && (
                  <div className="text-xs text-gray-500 mt-1">
                    vs â‚¬{stats.avgPricePerSqm.toLocaleString()} overall
                  </div>
                )}
              </>
            )}
            {dataSources.forSale && (
              <>
                <div className="text-sm text-gray-500 mb-1">
                  {(selectedYear !== null || recentFilter !== null) ? `${getTimeFilterLabel()} Avg â‚¬/mÂ²` : 'Asking Avg â‚¬/mÂ²'}
                </div>
                <div className="text-2xl font-bold text-white font-mono">
                  â‚¬{filteredListingStats.avgPricePerSqm.toLocaleString()}
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  {filteredListings.length.toLocaleString()} listings
                  {filteredListings.length !== listings.length && ` (of ${listings.length})`}
                </div>
              </>
            )}
            {dataSources.rentals && (
              <>
                <div className="text-sm text-gray-500 mb-1">Dublin Median Rent</div>
                <div className="text-2xl font-bold text-white font-mono">
                  â‚¬{rentalStats.medianRent.toLocaleString()}/mo
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  {filteredRentals.length.toLocaleString()} rentals
                </div>
                {rentalStats.avgRentPerSqm > 0 && (
                  <div className="text-xs text-gray-500 mt-1">
                    â‚¬{rentalStats.avgRentPerSqm.toFixed(2)}/mÂ² avg
                  </div>
                )}
              </>
            )}
            {activeSourceCount > 1 && (
              <>
                <div className="text-sm text-gray-500 mb-2">
                  {(selectedYear !== null || recentFilter !== null) ? `${getTimeFilterLabel()} Avg â‚¬/mÂ²` : 'Avg â‚¬/mÂ² Comparison'}
                </div>
                <div className="space-y-2">
                  <div className="flex items-center justify-between gap-3">
                    <span className="text-gray-200 text-sm">âšª Sold</span>
                    <span className="text-lg font-bold text-white font-mono">
                      â‚¬{filteredStats.avgPricePerSqm.toLocaleString()}
                    </span>
                  </div>
                  <div className="flex items-center justify-between gap-3">
                    <span className="text-rose-400 text-sm">ðŸ”´ For Sale</span>
                    <span className="text-lg font-bold text-white font-mono">
                      â‚¬{filteredListingStats.avgPricePerSqm.toLocaleString()}
                    </span>
                  </div>
                  <div className="flex items-center justify-between gap-3">
                    <span className="text-purple-400 text-sm">ðŸŸ£ Rentals</span>
                    <span className="text-lg font-bold text-white font-mono">
                      â‚¬{rentalStats.medianRent.toLocaleString()}/mo
                    </span>
                  </div>
                </div>
                {filteredListingStats.avgPricePerSqm > 0 && filteredStats.avgPricePerSqm > 0 && (
                  <div className="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-700">
                    {filteredListingStats.avgPricePerSqm > filteredStats.avgPricePerSqm 
                      ? `Asking ${((filteredListingStats.avgPricePerSqm - filteredStats.avgPricePerSqm) / filteredStats.avgPricePerSqm * 100).toFixed(1)}% above sold`
                      : filteredListingStats.avgPricePerSqm < filteredStats.avgPricePerSqm
                        ? `Asking ${((filteredStats.avgPricePerSqm - filteredListingStats.avgPricePerSqm) / filteredStats.avgPricePerSqm * 100).toFixed(1)}% below sold`
                        : 'Asking prices match sold prices'
                    }
                  </div>
                )}
              </>
            )}
            </div>
          </div>
        )}
        
        {/* View mode tips */}
        <div className="absolute bottom-4 right-4 hidden md:block">
          <div className="bg-gray-900/90 backdrop-blur-xl rounded-lg px-4 py-3 border border-gray-700 text-sm text-gray-400 max-w-xs">
            {viewMode === 'clusters' && (dataSources.sold || dataSources.forSale || dataSources.rentals) && (
              <p>ðŸ’¡ Click clusters to zoom in. Click {dataSources.sold ? 'properties' : dataSources.rentals ? 'rentals' : 'listings'} for details.</p>
            )}
            {viewMode === 'clusters' && activeSourceCount > 1 && (
              <p>ðŸ’¡ <span className="text-white">White</span> = Sold, <span className="text-rose-400">Pink</span> = For Sale, <span className="text-purple-400">Purple</span> = Rental. Click for details.</p>
            )}
            {viewMode === 'price' && (dataSources.sold || dataSources.forSale) && (
              <p>ðŸ’¡ Colors show {dataSources.sold ? 'sold' : 'asking'} price. Green = under â‚¬400k, Red = over â‚¬1M.</p>
            )}
            {viewMode === 'price' && dataSources.rentals && (
              <p>ðŸ’¡ Colors show monthly rent. Green = under â‚¬1,500, Red = over â‚¬3,000.</p>
            )}
            {viewMode === 'difference' && dataSources.sold && (
              <p>ðŸ’¡ Green = deals (sold under asking), Red = bidding wars (sold over asking).</p>
            )}
          </div>
        </div>
        
        {/* Hidden PropertySnapshot components for image generation */}
        {selectedProperty && (
          <PropertySnapshot 
            property={selectedProperty} 
            snapshotRef={soldSnapshotRef}
          />
        )}
        {selectedListing && (
          <PropertySnapshot 
            listing={selectedListing} 
            snapshotRef={listingSnapshotRef}
          />
        )}
        {selectedRental && (
          <PropertySnapshot 
            rental={selectedRental} 
            snapshotRef={rentalSnapshotRef}
          />
        )}

      </div>
    </div>
  );
}

// Global function for amenity popup buttons
if (typeof window !== 'undefined') {
  (window as any).getDirections = (amenityId: string) => {
    // This will be set by the component when amenities are loaded
  };
}
